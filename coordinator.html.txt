
<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.1/css/selectize.min.css" />

    <!--FULLCALENDAR!-->
    <?!= include('styleFullCalendar'); ?>

        <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>

        <?!= include('scriptFullCalendar'); ?>
            <script>
                $(document).ready(function() {
                    var date = new Date();
                    var d = date.getDate();
                    var m = date.getMonth();
                    var y = date.getFullYear();

                    /*  className colors

                    className: default(transparent), important(red), chill(pink), success(green), info(blue)

                    */

                    /* initialize the external events
                    -----------------------------------------------------------------*/

                    $('#external-events div.external-event').each(function() {

                        // create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
                        // it doesn't need to have a start or end
                        var eventObject = {
                            title: $.trim($(this).text()) // use the element's text as the event title
                        };

                        // store the Event Object in the DOM element so we can get to it later
                        $(this).data('eventObject', eventObject);

                        // make the event draggable using jQuery UI
                        $(this).draggable({
                            zIndex: 999,
                            revert: true, // will cause the event to go back to its
                            revertDuration: 0 //  original position after the drag
                        });

                    });

                    /* initialize the calendar
                    -----------------------------------------------------------------*/

                    var calendar = $('#calendar').fullCalendar({
                        header: {
                            left: 'title',
                            center: 'agendaDay,agendaWeek,month',
                            right: 'prev,next today'
                        },
                        editable: false,
                        firstDay: 1, //  1(Monday) this can be changed to 0(Sunday) for the USA system
                        selectable: true,
                        defaultView: 'month',

                        axisFormat: 'h:mm',
                        columnFormat: {
                            month: 'ddd', // Mon
                            week: 'ddd d', // Mon 7
                            day: 'dddd M/d', // Monday 9/7
                            agendaDay: 'dddd d'
                        },
                        titleFormat: {
                            month: 'MMMM yyyy', // September 2009
                            week: "MMMM yyyy", // September 2009
                            day: 'MMMM yyyy' // Tuesday, Sep 8, 2009
                        },
                        allDaySlot: false,
                        selectHelper: true,
                        eventColor: '#f98585'

                    });

                });
   
            </script>
            <style>
                #wrap {
                    /*
		width: 1100px;
		margin: 0 auto;*/
                    overflow-x: auto;
                    padding: 1px;
                }
                
                #external-events {
                    float: left;
                    width: 150px;
                    padding: 0 10px;
                    text-align: left;
                }
                
                #external-events h4 {
                    font-size: 16px;
                    margin-top: 0;
                    padding-top: 1em;
                }
                
                .external-event {
                    /* try to mimick the look of a real event */
                    margin: 10px 0;
                    padding: 2px 4px;
                    background: #3366CC;
                    color: #fff;
                    font-size: .85em;
                    cursor: pointer;
                }
                
                #external-events p {
                    margin: 1.5em 0;
                    font-size: 11px;
                    color: #666;
                }
                
                #external-events p input {
                    margin: 0;
                    vertical-align: middle;
                }
                
                #calendar {
                    /* 		float: right; 
        margin: 0 auto;*/
                    width: 900px;
                    background-color: #FFFFFF;
                    border-radius: 6px;
                    box-shadow: 0 1px 2px #C3C3C3;
                }
            </style>

            <!--FULLCALENDAR!-->

</head>

<style>
    /* Date Picker Default Styles */
    
    .ui-datepicker {
        padding: 0;
        margin: 0;
        -webkit-border-radius: 0;
        -moz-border-radius: 0;
        border-radius: 0;
        background-color: #fff;
        border: 1px solid #dfdfdf;
        border-top: none;
        -webkit-box-shadow: 0 3px 6px rgba(0, 0, 0, 0.075);
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.075);
        min-width: 17em;
        width: auto;
        z-index: 1000 !important;
    }
    
    body.wp-admin:not(.rtl) .ui-datepicker {
        margin-left: -1px;
    }
    
    body.wp-admin.rtl .ui-datepicker {
        margin-right: -1px;
    }
    
    .ui-datepicker * {
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
        -webkit-border-radius: 0;
        -moz-border-radius: 0;
        border-radius: 0;
    }
    
    .ui-datepicker table {
        font-size: 13px;
        margin: 0;
        border: none;
        border-collapse: collapse;
    }
    
    .ui-datepicker .ui-widget-header,
    .ui-datepicker .ui-datepicker-header {
        background-image: none;
        border: none;
        color: #fff;
        font-weight: normal;
    }
    
    .ui-datepicker .ui-datepicker-header .ui-state-hover {
        background: transparent;
        border-color: transparent;
        cursor: pointer;
    }
    
    .ui-datepicker .ui-datepicker-title {
        margin: 0;
        padding: 10px 0;
        color: #fff;
        font-size: 14px;
        line-height: 14px;
        text-align: center;
    }

    
    .ui-datepicker select.ui-datepicker-month,
    .ui-datepicker select.ui-datepicker-year {
        width: 33%;
    }
    
    .ui-datepicker thead {
        color: #fff;
        font-weight: 600;
    }
    
    .ui-datepicker th {
        padding: 10px;
    }
    
    .ui-datepicker td {
        padding: 0;
        border: 1px solid #f4f4f4;
    }
    
    .ui-datepicker td.ui-datepicker-other-month {
        border: transparent;
    }
    
    .ui-datepicker tr:first-of-type td {
        border-top: 1px solid #f0f0f0;
    }
    
    .ui-datepicker td.ui-datepicker-week-end {
        background-color: #f4f4f4;
        border: 1px solid #f0f0f0;
    }
    
    .ui-datepicker td.ui-datepicker-today {
        background-color: #f0f0c0;
    }
    
    .ui-datepicker td.ui-datepicker-current-day {
        background: #bbdd88;
    }
    
    .ui-datepicker td .ui-state-default {
        background: transparent;
        border: none;
        text-align: center;
        text-decoration: none;
        width: auto;
        display: block;
        padding: 5px 10px;
        font-weight: normal;
        color: #444;
    }
    
    .ui-datepicker td.ui-state-disabled .ui-state-default {
        opacity: 0.5;
    }
    /* Mint */
    
    .admin-color-bbp-mint .ui-datepicker .ui-widget-header,
    .admin-color-bbp-mint .ui-datepicker .ui-datepicker-header {
        background: #4ca26a;
    }
    
    .admin-color-bbp-mint .ui-datepicker thead {
        background: #4f6d59;
    }
    
    .admin-color-bbp-mint .ui-datepicker td .ui-state-hover {
        background: #5fb37c;
        color: #fff;
    }
    
    .ui-datepicker .ui-datepicker-title {
        color: #000;
    }
    
    .ui-widget {
        font-family: BlinkMacSystemFont, -apple-system, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    
    .invoice-box {
        max-width: 800px;
        margin: auto;
        margin-top: 30px;
        margin-bottom: 50px;
        padding: 0px;
        border: none;
        box-shadow: 0 0 10px rgba(0, 0, 0, .15);
        line-height: 24px;
        color: #555;
        display: none;
    }
    
    .signature-pad {
        width: 250px;
        height: 150px;
        background-color: white;
        border: thin solid;
        border-color: #dbdbdb;
        color: #363636;
        box-shadow: inset 0 1px 2px rgba(10, 10, 10, .1);
        border-radius: 4px;
    }
    
    .loading {
        background-color: #ffffff;
        background-image: url("https://c.tenor.com/I6kN-6X7nhAAAAAj/loading-buffering.gif");
        background-size: 25px 25px;
        background-position: left center;
        background-repeat: no-repeat;
        background-position-x: 50%;
    }
    
    .summary-table td {
        padding-bottom: 5px;
    }
    
    .radio {
        padding-bottom: 10px;
    }

    .disabled-link {
      pointer-events: none;
    }   

    .box{
    padding: 0.8rem;
    text-align: center;
    }

    .header-simple-calendar{
        background-color: #00d1b2;
        color: white;
        font-weight: 700;
    }

    #cover-spin {
    position:fixed;
    width:100%;
    left:0;right:0;top:0;bottom:0;
    background-color: rgba(255,255,255,0.7);
    z-index:9999;
    display:none;
}

@-webkit-keyframes spin {
	from {-webkit-transform:rotate(0deg);}
	to {-webkit-transform:rotate(360deg);}
}

@keyframes spin {
	from {transform:rotate(0deg);}
	to {transform:rotate(360deg);}
}

#cover-spin::after {
    content:'';
    display:block;
    position:absolute;
    left:48%;top:40%;
    width:40px;height:40px;
    border-style:solid;
    border-color:black;
    border-top-color:transparent;
    border-width: 4px;
    border-radius:50%;
    -webkit-animation: spin .8s linear infinite;
    animation: spin .8s linear infinite;
}

.card {
margin-bottom : 40px;
border-radius: 6px;
}

.card-header-title {
    display: block;
    text-align: center;
    color:white;
}

.content table td {
    border-width: 0 0 0px;
}

/* Schedule View Styles */
.team-row {
    display: flex;
    border-bottom: 1px solid #555;
    min-height: 120px; /* Height of each team row */
    padding: 20px;
    position: relative;
}

.team-name-col {
    width: 150px; /* Fixed width for Team Name */
    min-width: 150px;
    background-color: #444;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border-right: 1px solid #777;
    font-weight: bold;
    z-index: 10;
}

.timeline-track {
    flex-grow: 1;
    position: relative; /* This allows absolute positioning of cards inside */
    background-color: #fdfdfd; /* Light background for the track */
}

/* Vertical grid lines for visual aid */
.grid-line {
    position: absolute;
    top: 0; bottom: 0;
    width: 1px;
    background-color: #eee;
    z-index: 0;
}

/* The Booking Card */
.booking-card {
    position: absolute;
    top: 10px;
    height: 100px;
    background-color: #ffdd57; /* Default color */
    border-radius: 4px;
    padding: 5px;
    font-size: 11px;
    color: #333;
    overflow: hidden;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    z-index: 5;
    border-left: 5px solid #333;
    cursor: pointer;
    transition: transform 0.2s;
}

.booking-card:hover {
    transform: scale(1.02);
    z-index: 10;
}

/* Status Colors */
.status-Confirmed { background-color: #90EE90; border-left-color: green; }
.status-Scheduled { background-color: #FFB6C1; border-left-color: #C71585; }
.status-Completed { background-color: #D3D3D3; border-left-color: #666; }

/* Update the modal card width to be comfortable */
.modal-card {
    width: 600px;
    max-width: 95vw; /* Ensure it fits on mobile screens */
}
.modal-card-body {
    overflow-y: visible !important;
    overflow-x: hidden;
}

/* Ensure dropdowns inside the modal take full width */
.selectize-input {
    width: 100% !important;
}
/* Container for the rows only (not the header) */
#schedule-rows {
    /* 120px per row * 4 rows = 480px */
    height: 480px; 
    
    /* Enables vertical scrolling */
    overflow-y: auto; 
    
    /* Hides horizontal scrollbar on the rows container itself 
       (the main container handles X scrolling) */
    overflow-x: hidden; 
    
    /* Optional: Adds a nice border at the bottom */
    border-bottom: 1px solid #555;
}

/* Ensure the scrollbar looks good (Optional, works in Chrome/Safari) */
#schedule-rows::-webkit-scrollbar {
    width: 10px;
}
#schedule-rows::-webkit-scrollbar-track {
    background: #333; 
}
#schedule-rows::-webkit-scrollbar-thumb {
    background: #888; 
    border-radius: 5px;
}
#schedule-rows::-webkit-scrollbar-thumb:hover {
    background: #555; 
}
/* --- NEW SCHEDULE STYLES --- */

/* The Legend Bar */
.legend-bar {
    display: flex;
    gap: 15px;
    padding: 10px;
    background-color: #363636;
    color: white;
    font-size: 0.9em;
    border-radius: 6px 6px 0 0;
    margin-bottom: 0;
}

.legend-item {
    display: flex;
    align-items: center;
}

.color-box {
    width: 15px;
    height: 15px;
    margin-right: 5px;
    border-radius: 3px;
    border: 1px solid #555;
}

/* Scrollable Container */
#schedule-container {
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 0 0 6px 6px;
    overflow-x: auto; /* Allow side scrolling */
    position: relative;
}

/* The layout requires a wide area to fit 30-min slots */
.timeline-wrapper {
    min-width: 2600px; /* Forces horizontal scroll */
    position: relative;
}

/* Header Row */
.schedule-header-row {
    display: flex;
    background-color: #f5f5f5;
    border-bottom: 2px solid #ddd;
    height: 40px;
    margin-left: 150px; /* Offset for Team Name column */
}

.header-time-slot {
    flex: 1; /* Distribute space evenly */
    border-right: 1px solid #e0e0e0;
    text-align: center;
    line-height: 40px;
    font-size: 12px;
    font-weight: bold;
    color: #555;
}

/* Team Rows */
.team-row {
    display: flex;
    border-bottom: 1px solid #eee;
    height: 100px; /* Fixed height for rows */
    padding: 20px;
    background-color: #fafafa; /* "Free Time" color */
}

.team-name-col {
    width: 150px;
    min-width: 150px;
    background-color: #4a4a4a;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    position: sticky;
    left: 0;
    z-index: 20;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

.timeline-track {
    flex-grow: 1;
    position: relative;
}

/* Vertical Grid Lines inside the track */
.grid-line-30 {
    position: absolute;
    top: 0; bottom: 0;
    width: 1px;
    background-color: #f0f0f0; /* Faint line */
    z-index: 1;
}

.grid-line-hour {
    position: absolute;
    top: 0; bottom: 0;
    width: 1px;
    background-color: #d0d0d0; /* Stronger line */
    z-index: 1;
}

/* Booking Cards */
.booking-card {
    position: absolute;
    top: 10px; bottom: 10px;
    border-radius: 4px;
    padding: 4px;
    font-size: 10px;
    color: #333;
    overflow: hidden;
    z-index: 10;
    box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    cursor: pointer;
    white-space: nowrap;
    text-overflow: ellipsis;
    transition: all 0.2s;
}
.booking-card:hover {
    z-index: 20;
    transform: scale(1.02);
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
}
body {
        background-color: #F3F4F6; /* Light gray background for the page */
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    /* --- THE MAIN CARD --- */
    .invoice-card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 40px;
        max-width: 900px;
        margin: 40px auto;
        border: 1px solid #E5E7EB;
    }

    .card-heading {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 25px;
    }

    /* --- TABLE STYLES --- */
    .clean-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px; /* Spacing between rows */
    }

    .clean-table th {
        text-align: left;
        font-size: 0.85rem;
        font-weight: 600;
        color: #6B7280; /* Gray text */
        padding-bottom: 10px;
        border: none;
    }

    .clean-table td {
        border: none;
        vertical-align: top;
        padding: 0 5px;
    }

    /* --- INPUTS --- */
    .chip-input {
        background-color: #F9FAFB !important; /* Very light gray bg */
        border: 1px solid #E5E7EB !important;
        border-radius: 6px !important;
        box-shadow: none !important;
        height: 42px;
        font-size: 0.95rem;
        color: #374151;
        transition: border-color 0.2s;
    }

    .chip-input:focus {
        background-color: #fff !important;
        border-color: #10B981 !important; /* Teal focus border */
        box-shadow: 0 0 0 1px #10B981 !important;
    }

    /* --- DASHED ADD BUTTON --- */
    .dashed-add-btn {
        border: 2px dashed #E5E7EB;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        color: #6B7280;
        cursor: pointer;
        margin-top: 10px;
        margin-bottom: 30px;
        transition: all 0.2s;
        font-weight: 600;
        background-color: white;
    }

    .dashed-add-btn:hover {
        border-color: #10B981;
        color: #10B981;
        background-color: #ECFDF5;
    }

    /* --- GRAY FOOTER BOX --- */
    .footer-box {
        background-color: #F9FAFB; /* Light gray box */
        border-radius: 12px;
        padding: 25px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .total-label {
        display: block;
        font-size: 0.75rem;
        color: #6B7280;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .total-value {
        font-size: 2rem;
        font-weight: 800;
        color: #111827;
        line-height: 1;
    }

    /* --- TEAL BUTTON --- */
    .teal-btn {
        background-color: #10B981 !important; /* Teal color */
        color: white !important;
        border: none !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        border-radius: 6px !important;
        height: auto !important;
        font-size: 1rem !important;
        transition: background-color 0.2s;
    }

    .teal-btn:hover {
        background-color: #059669 !important;
    }

    .teal-btn.is-loading::after {
        border-color: transparent transparent white white !important;
    }

    /* --- RADIO BUTTONS --- */
    .payment-status-container {
        margin-top: 20px;
        padding-left: 5px;
    }
    
    .payment-label {
        font-size: 0.9rem;
        font-weight: 700;
        color: #374151;
        margin-bottom: 10px;
        display: block;
    }

    .radio-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .radio-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #4B5563;
        cursor: pointer;
    }

    .radio-item input {
        margin-right: 6px;
    }

/* Specific Colors based on your Legend */
.status-Booked { background-color: #ffcdd2; border: 1px solid #e57373; } /* Pink */
.status-Invoiced { background-color: #b0bec5; border: 1px solid #78909c; } /* Grey */
.status-Current { background-color: #00e676; border: 1px solid #00c853; } /* Green */
.status-Other { background-color: #fff9c4; border: 1px solid #fbc02d; } /* Yellow */

/* --- NEW UI STYLES --- */
    .chip-input {
        background-color: #F9FAFB !important;
        border: 1px solid #E5E7EB !important;
        border-radius: 8px !important;
        box-shadow: none !important;
        height: 45px;
        padding-left: 15px;
    }
    .chip-input:focus {
        background-color: #fff !important;
        border-color: #00d1b2 !important;
    }
    .clean-table th {
        border: none !important;
        color: #374151 !important;
        font-weight: 600;
        padding-bottom: 10px;
    }
    .clean-table td {
        border: none !important;
        padding: 5px 2px !important;
        vertical-align: middle !important;
    }
    .dashed-add-btn {
        border: 2px dashed #E5E7EB;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        color: #6B7280;
        cursor: pointer;
        margin-top: 15px;
        transition: all 0.2s;
        font-weight: 500;
    }
    .dashed-add-btn:hover {
        border-color: #00d1b2;
        color: #00d1b2;
        background-color: #f0xfdff;
    }
    .dark-header {
        background-color: #0B1120; /* Very dark blue */
        color: white;
        padding: 30px;
        border-radius: 12px 12px 0 0;
    }
    .grand-total-box {
        background-color: #F9FAFB;
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* Fix for Table Inputs */
.clean-table input.chip-input {
    height: 38px !important; /* Smaller height for table */
    font-size: 0.9rem;
    padding-left: 8px;
    border-radius: 6px !important;
}

/* Ensure table cells align nicely */
.clean-table td {
    padding: 8px 4px !important; /* Give cells some breathing room */
}
    /* FIX FOR SQUISHED UI */
    .form-section-header {
        border-bottom: 1px solid #dbdbdb;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        color: #363636;
        font-weight: 600;
        font-size: 1.1rem;
        margin-top: 1rem;
    }

    .form-row-spacer {
        margin-bottom: 2rem;
    }

    /* Make Selectize match Bulma Inputs */
    .selectize-input {
        border: 1px solid #dbdbdb !important;
        border-radius: 4px !important;
        box-shadow: inset 0 1px 2px rgba(10, 10, 10, .1) !important;
        padding: 8px 10px !important;
        min-height: 40px !important; /* Match Bulma input height */
    }
    
    .selectize-control.multi .selectize-input > div {
        background: #effaf5 !important; /* Light green tag */
        color: #257953 !important;
        border: 1px solid #257953 !important; 
        border-radius: 3px;
    }

    /* Table Spacing */
    #table-normal-assignments th, 
    #table-normal-assignments td,
    #table-multiday-dates th,      /* <--- Added this */
    #table-multiday-dates td {     /* <--- Added this */
        vertical-align: middle;
        text-align: center;
    }
    
    /* Ensure the delete button column doesn't take too much space */
    ..action-col {
        width: 60px;
        text-align: center;
    }
    .table-container {
        background-color: white;
        border-radius: 6px;
        box-shadow: 0 2px 3px rgba(10, 10, 10, 0.1);
        padding: 5px;
        overflow: visible !important;
    }
/*-----------------------------------------------------------------------------/*
 /* --- NEW GANTT & SHIFT STYLES --- */

/* Scrollable Container */
#schedule-container {
    background-color: #f4f4f4;
    border: 1px solid #ccc;
    border-radius: 0 0 6px 6px;
    overflow-x: auto;
    position: relative;
    max-height: 80vh; /* Allow vertical scroll for many teams */
}

.timeline-wrapper {
    min-width: 2800px; /* Wide enough for 5am to 11pm */
    position: relative;
    background-color: #555; /* Dark background behind rows */
}

/* --- HEADER SECTION --- */
.schedule-header-group {
    margin-left: 150px; /* Offset for Team Name */
    position: sticky;
    top: 0;
    z-index: 30;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Top Row: Shifts (Morning, Afternoon, etc.) */
.shift-header-row {
    display: flex;
    height: 30px;
    color: #333;
    font-weight: bold;
    font-size: 12px;
    text-transform: uppercase;
    text-align: center;
    line-height: 30px;
}

.shift-block { flex: 1; border-right: 1px solid rgba(0,0,0,0.1); }
.shift-morning { background-color: #E8EAF6; color: #3F51B5; } /* Light Indigo */
.shift-afternoon { background-color: #FFF3E0; color: #E65100; } /* Light Orange */
.shift-evening { background-color: #E3F2FD; color: #1565C0; } /* Light Blue */
.shift-night { background-color: #F3E5F5; color: #4A148C; } /* Light Purple */

/* Bottom Row: Time Slots */
.time-header-row {
    display: flex;
    height: 30px;
    background-color: #fff;
    border-bottom: 2px solid #ddd;
}

.header-time-slot {
    flex: 1;
    border-right: 1px solid #eee;
    text-align: center;
    line-height: 30px;
    font-size: 11px;
    color: #666;
    font-weight: 600;
}

/* --- BODY SECTION --- */
.team-row {
    display: flex;
    border-bottom: 1px solid #666; /* Darker border for contrast */
    background-color: #888; /* Dark grey background for empty space */
    position: relative;
    min-height: 80px; /* Minimum height */
    transition: height 0.2s;
}

.team-name-col {
    width: 150px;
    min-width: 150px;
    background-color: #fff;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    position: sticky;
    left: 0;
    z-index: 20;
    border-right: 1px solid #ccc;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

.timeline-track {
    flex-grow: 1;
    position: relative;
    /* Grid lines background */
    background-image: linear-gradient(to right, #777 1px, transparent 1px);
    background-size: 2.77% 100%; /* Approx width of 30 mins */
}

/* --- THE CARD --- */
.calendar-card {
    position: absolute;
    height: 70px; /* Fixed height for cards */
    border-radius: 4px;
    padding: 5px;
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    font-size: 10px;
    color: #333;
    overflow: hidden;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: transform 0.1s ease, z-index 0.1s;
    border: 1px solid rgba(0,0,0,0.1);
}

.calendar-card:hover {
    z-index: 50 !important; /* Bring to very front */
    transform: scale(1.02);
    box-shadow: 0 5px 15px rgba(0,0,0,0.4);
}

/* Status Colors (Pastel backgrounds + Strong Borders) */
.cc-status-scheduled { background-color: #FFEBEE; border-left: 5px solid #E57373; } /* Pink/Red */
.cc-status-active    { background-color: #E8F5E9; border-left: 5px solid #00E676; } /* Green */
.cc-status-invoiced  { background-color: #ECEFF1; border-left: 5px solid #78909C; } /* Grey */
.cc-status-other     { background-color: #FFFDE7; border-left: 5px solid #FDD835; } /* Yellow */

/* Card Internals */
.cc-header { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 2px; }
.cc-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
.cc-row { display: flex; align-items: center; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cc-badge { background-color: #546E7A; color: white; padding: 1px 4px; border-radius: 2px; font-size: 8px; font-weight: bold; text-transform: uppercase; margin-left: auto;}

/* The Cyan Eye Button */
.cc-btn {
    width: 20px; height: 20px;
    background-color: #00BCD4; /* Cyan */
    color: white;
    border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
    position: absolute;
    bottom: 4px; right: 4px;
    font-size: 10px;
}
.cc-btn:hover { background-color: #00ACC1; }

</style>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>

<body>

  <div id="cover-spin"></div>

    <div class="container" style="margin-top: 50px;">

        <nav class="level">
            <div class="level-left">
                <div class="level-item">
                    <figure class="image is-64x64">
                        <img src="https://drive.google.com/drive/u/0/folders/1QwaDitmH7LD_lSs2C9aP-vSHTezdbhJg">
                    </figure>
                </div>
                <div class="level-item">
                    <h1 class="title">RSH</h1>
                </div>
            </div>
        </nav>

        <br>

        <div class="tabs is-boxed" id="tabs">
            <ul>
                <li class="is-active">
                    <a>
                        <span>Home</span>
                    </a>
                </li>
                <li>
                    <a>
                        <span>Coordinator</span>
                    </a>
                </li>
                <li id="link-tab-team-leader">
                    <a>
                        <span>Team Leader</span>
                    </a>
                </li>
                <li id="link-tab-pending-payment">
                    <a>
                        <span>Pending Payment</span>
                    </a>
                </li>
                <li id="link-tab-completed-orders">
                    <a>
                        <span>Completed Orders</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="page box" style="margin-top:50px">
            Choose the relevant tab based on your role.
        </div>

        <div class="page">

            <!--ASK FOR COORDINATOR PASSWORD!-->

            <div id="password-div" style="margin-top:50px;padding:1rem">

                <label class="label">Please enter coordinator password</label>

                <div class="control">
                    <input class="input" type="password" id='coordinator-password' style="width:270px;">
                </div>

                <br>

                <div>
                    <a class="button is-primary" id="button-submit-password">Log in</a>
                </div>

            </div>

            <div id="protected-div">

                <section class="section">
                    <div class="container" id="container-add-order" style="visibility:hidden;">
                        <h1 class="title is-4">Calendar</h1>

                        <!--FullCalendar!-->

                        <div id='wrap'>

                        <div class="field">
                        <label class="label">Select Date to View Schedule</label>
                        <div class="control has-icons-left">
                        <input class="input" type="text" id="schedule-date-picker" placeholder="Select Date" style="width: 200px;">
                        <span class="icon is-small is-left">
                        <i class="fas fa-calendar"></i>
                        </span>
                        </div>
                        </div>
                        <div class="legend-bar">
                        <span class="legend-item"><span class="color-box" style="background:#4a4a4a"></span> Team Name</span>
                        <span class="legend-item"><span class="color-box" style="background:#fafafa"></span> Free Time</span>
                        <span class="legend-item"><span class="color-box" style="background:#ffcdd2"></span> Booked (Scheduled)</span>
                        <span class="legend-item"><span class="color-box" style="background:#b0bec5"></span> Invoiced (Paid)</span>
                        <span class="legend-item"><span class="color-box" style="background:#00e676"></span> Current Order</span>
                        </div>

                        <div id="schedule-container" style="display:none;">
                        <div class="timeline-wrapper">
                        <div class="schedule-header-row" id="schedule-header-row"></div>
        
                        <div id="schedule-rows"></div>
                        </div>
                        </div>
                            <div style='clear:both'></div>

                        </div>

                        <br>
                        <br>
                        <!--FullCalendar!-->
                        
                        
                      

                        <br>
                        <br>
                        <div style="display:none;">
                        <span id="text-order-num"></span>
                        <span id="text-customer-name"></span>
                        <span id="text-customer-phone"></span>
                        </div>
                        <h1 class="title is-4">Add Order</h1>

                        <!--Select type of order!-->
                        <div class="columns">
                               <div class="column is-3">    
                                    <div class="field">
                                    <label class="label">Order Type</label>
                                    <div class="control">
                                        <div class="select" style="width:100%;">
                                            <select id='select-order-type' style="width:100%;">
                                            <option value='Please Select'>Please select</option>
                                            <option value='Normal Order'>Normal Order</option>
                                            <option value='Multi-day Order'>Multi-day Order</option>
                                            <option value='Back Order'>Back Order</option>
                                            <option value='Wait List'>Wait List</option>
                                            <option value='Rejected Order'>Rejected Order</option>
                                            </select>
                                          </div>
                                    </div>
                                </div>     
                               </div>
                              
                              <div class="column is-3" id="form-past-booking">    
                                    <div class="field">
                                    <label class="label">Past Bookings</label>
                                    <div class="control">
                                        <input class="input" type="text" id="select-past-booking">
                                    </div>
                                </div>     
                               </div>
                        </div>

                        <br>





                      <!--Start Modal for Alert Conflict-->
                      <div class="modal conflict">
                        <div class="modal-background"></div>
                        <div class="modal-card">
                          <header class="modal-card-head">
                            <p class="modal-card-title">Conflict Detected!</p>
                            <button class="delete" aria-label="close" id="button-close-modal-conflict"></button>
                          </header>
                          <section class="modal-card-body">
                            <p id='conflict-msg'></p>
                          </section>
                          <footer class="modal-card-foot">
                            <button class="button is-primary" id="button-add-order-ignore-conflict">Proceed Anyway</button>
                            <button class="button" id="button-cancel-modal-conflict">Cancel</button>
                          </footer>
                      
                        </div>
                      </div>
                      <!--End Modal for Alert Conflict-->


                        <!--Start of div form-normal-order!-->
                        <div id='form-normal-order' class='form-order'>
    
    <h3 class="form-section-header"><i class="far fa-clock"></i> Scheduling</h3>
    <div class="columns form-row-spacer">
        <div class="column is-4">
            <div class="field">
                <label class="label">Date</label>
                <div class="control has-icons-left">
                    <input class="input" type="text" id="add-order-date" readonly="readonly" placeholder="Select Date">
                    <span class="icon is-small is-left">
                        <i class="fas fa-calendar"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">Start Time</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id='add-order-time'>
                            <option value='6:00 AM'>6:00 AM</option>
                            <option value='6:30 AM'>6:30 AM</option>
                            <option value='7:00 AM'>7:00 AM</option>
                            <option value='7:30 AM'>7:30 AM</option>
                            <option value='8:00 AM'>8:00 AM</option>
                            <option value='8:30 AM'>8:30 AM</option>
                            <option value='9:00 AM'>9:00 AM</option>
                            <option value='9:30 AM'>9:30 AM</option>
                            <option value='10:00 AM'>10:00 AM</option>
                            <option value='10:30 AM'>10:30 AM</option>
                            <option value='11:00 AM'>11:00 AM</option>
                            <option value='11:30 AM'>11:30 AM</option>
                            <option value='12:00 PM'>12:00 PM</option>
                            <option value='12:30 PM'>12:30 PM</option>
                            <option value='1:00 PM'>1:00 PM</option>
                            <option value='1:30 PM'>1:30 PM</option>
                            <option value='2:00 PM'>2:00 PM</option>
                            <option value='2:30 PM'>2:30 PM</option>
                            <option value='3:00 PM'>3:00 PM</option>
                            <option value='3:30 PM'>3:30 PM</option>
                            <option value='4:00 PM'>4:00 PM</option>
                            <option value='4:30 PM'>4:30 PM</option>
                            <option value='5:00 PM'>5:00 PM</option>
                            <option value='5:30 PM'>5:30 PM</option>
                            <option value='6:00 PM'>6:00 PM</option>
                            <option value='6:30 PM'>6:30 PM</option>
                            <option value='7:00 PM'>7:00 PM</option>
                            <option value='7:30 PM'>7:30 PM</option>
                            <option value='8:00 PM'>8:00 PM</option>
                            <option value='8:30 PM'>8:30 PM</option>
                            <option value='9:00 PM'>9:00 PM</option>
                            <option value='9:30 PM'>9:30 PM</option>
                            <option value='10:00 PM'>10:00 PM</option>
                            <option value='10:30 PM'>10:30 PM</option>
                            <option value='11:00 PM'>11:00 PM</option>
                            <option value='11:30 PM'>11:30 PM</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">End Time</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id='add-order-end-time'>
                            <option value='6:00 AM'>6:00 AM</option>
                            <option value='6:30 AM'>6:30 AM</option>
                            <option value='7:00 AM'>7:00 AM</option>
                            <option value='7:30 AM'>7:30 AM</option>
                            <option value='8:00 AM'>8:00 AM</option>
                            <option value='8:30 AM'>8:30 AM</option>
                            <option value='9:00 AM'>9:00 AM</option>
                            <option value='9:30 AM'>9:30 AM</option>
                            <option value='10:00 AM'>10:00 AM</option>
                            <option value='10:30 AM'>10:30 AM</option>
                            <option value='11:00 AM'>11:00 AM</option>
                            <option value='11:30 AM'>11:30 AM</option>
                            <option value='12:00 PM'>12:00 PM</option>
                            <option value='12:30 PM'>12:30 PM</option>
                            <option value='1:00 PM'>1:00 PM</option>
                            <option value='1:30 PM'>1:30 PM</option>
                            <option value='2:00 PM'>2:00 PM</option>
                            <option value='2:30 PM'>2:30 PM</option>
                            <option value='3:00 PM'>3:00 PM</option>
                            <option value='3:30 PM'>3:30 PM</option>
                            <option value='4:00 PM'>4:00 PM</option>
                            <option value='4:30 PM'>4:30 PM</option>
                            <option value='5:00 PM'>5:00 PM</option>
                            <option value='5:30 PM'>5:30 PM</option>
                            <option value='6:00 PM'>6:00 PM</option>
                            <option value='6:30 PM'>6:30 PM</option>
                            <option value='7:00 PM'>7:00 PM</option>
                            <option value='7:30 PM'>7:30 PM</option>
                            <option value='8:00 PM'>8:00 PM</option>
                            <option value='8:30 PM'>8:30 PM</option>
                            <option value='9:00 PM'>9:00 PM</option>
                            <option value='9:30 PM'>9:30 PM</option>
                            <option value='10:00 PM'>10:00 PM</option>
                            <option value='10:30 PM'>10:30 PM</option>
                            <option value='11:00 PM'>11:00 PM</option>
                            <option value='11:30 PM'>11:30 PM</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h3 class="form-section-header"><i class="fas fa-users"></i> Team & Service</h3>
    <div class="columns form-row-spacer">
        <div class="column is-12">
            <table class="table is-bordered is-fullwidth is-hoverable" id="table-normal-assignments">
                <thead class="has-background-white-ter">
                    <tr>
                        <th>Team</th>
                        <th>Service</th>
                        <th class="action-col">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <a class="button is-small is-info is-outlined" id="btn-add-assignment-row">
                <span class="icon"><i class="fas fa-plus"></i></span>
                <span>Add Team/Service</span>
            </a>
        </div>
    </div>

    <h3 class="form-section-header"><i class="fas fa-user"></i> Customer Details</h3>
    <div class="columns">
        <div class="column is-4">
            <div class="field">
                <label class="label">Customer Phone</label>
                <div class="control">
                    <input class="input" type="text" id="add-order-customer-call" placeholder="Search Phone...">
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">Customer Phone 2 (Optional)</label>
                <div class="control">
                    <input class="input" type="text" id="add-order-customer-call-2">
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">Customer Name</label>
                <div class="control">
                    <input class="input" type="text" id="add-order-customer-name" autocomplete="nope">
                </div>
            </div>
        </div>
    </div>
    
    <h3 class="form-section-header"><i class="fas fa-map-marker-alt"></i> Location & Info</h3>
    <div class="columns">
        <div class="column is-4" id="add-order-address-select-field">
            <div class="field">
                <label class="label">Address Selection</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id='add-order-address-select' class='address-select'>
                            <option value='Please Select'>Please select</option>
                            <option value='newaddress'>Add new address</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">Address Label</label>
                <div class="control">
                    <input class="input" type="text" id='add-order-address-label' placeholder="e.g. Home, Office">
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">Address Link</label>
                <div class="control">
                    <input class="input" type="text" id='add-order-address-link' placeholder="Google Maps Link">
                </div>
            </div>
        </div>
    </div>

    <div class="columns form-row-spacer">
        <div class="column is-6">
            <div class="field">
                <label class="label">Where do they know us from?</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id='add-order-where-know' class='where-know'>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-6">
            <div class="field">
                <label class="label">Notes</label>
                <div class="control">
                    <input class="input" type="text" id='add-order-note' placeholder="Gate code, special instructions...">
                </div>
            </div>
        </div>
    </div>

    <div class="columns">
        <div class="column is-12 has-text-right">
            <button class="button is-primary is-medium" id="button-add-order" style="width: 200px;">
                <span class="icon"><i class="fas fa-check"></i></span>
                <span>Add Order</span>
            </button>
            <div id="msg-normal-order" class="notification is-success is-light" style="display:none; margin-top: 15px; text-align: center;"></div>
        </div>
    </div>

</div> <!--End of div 'form-normal-order'-->

                   <div id='form-multiday-order' class='form-order' style="display:none;">

    <h3 class="form-section-header"><i class="far fa-calendar-alt"></i> Schedule Dates</h3>
    <div class="columns form-row-spacer">
        <div class="column is-12">
            <div class="table-container">
                <table class="table is-bordered is-fullwidth is-hoverable" id="table-multiday-dates">
                    <thead class="has-background-white-ter">
                        <tr>
                            <th style="width: 200px;">Date</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Team</th> 
                            <th>Service</th> 
                            <th class="action-col">Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <a class="button is-small is-info is-outlined" id="button-add-multiday-row">
                <span class="icon is-small"><i class="fas fa-plus"></i></span>
                <span>Add Date Row</span>
            </a>
        </div>
    </div>

    <h3 class="form-section-header"><i class="fas fa-user"></i> Customer Details</h3>
    <div class="columns">
        <div class="column is-4">
            <div class="field">
                <label class="label">Customer Phone</label>
                <div class="control">
                    <input class="input" type="text" id="multiday-customer-phone" placeholder="Search Phone...">
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">Customer Phone 2 (Optional)</label>
                <div class="control">
                    <input class="input" type="text" id="multiday-customer-phone-2">
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">Customer Name</label>
                <div class="control">
                    <input class="input" type="text" id="multiday-customer-name">
                </div>
            </div>
        </div>
    </div>

    <h3 class="form-section-header"><i class="fas fa-map-marker-alt"></i> Location & Info</h3>
    <div class="columns">
        <div class="column is-4">
            <div class="field">
                <label class="label">Address Selection</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id='multiday-address-select' class='address-select' style="width:100%;">
                            <option value='Please Select'>Please select</option>
                            <option value='newaddress'>Add new address</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">Address Label</label>
                <div class="control">
                    <input class="input" type="text" id='multiday-address-label' placeholder="e.g. Home, Office">
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">Address Link</label>
                <div class="control">
                    <input class="input" type="text" id='multiday-address-link' placeholder="Google Maps Link">
                </div>
            </div>
        </div>
    </div>

    <div class="columns form-row-spacer">
        <div class="column is-6">
            <div class="field">
                <label class="label">Where do they know us from?</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id='multiday-where-know' class='where-know' style="width:100%;">
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-6">
            <div class="field">
                <label class="label">Notes</label>
                <div class="control">
                    <input class="input" type="text" id='multiday-note' placeholder="Gate code, instructions for all teams...">
                </div>
            </div>
        </div>
    </div>

    <div class="columns">
        <div class="column is-12 has-text-right">
            <a class="button is-primary is-medium" id="button-submit-multiday" style="width: 200px;">
                <span class="icon"><i class="fas fa-check"></i></span>
                <span>Submit Multi-day</span>
            </a>
            <div id="msg-multiday-order" class="notification is-success is-light" style="display:none; margin-top: 15px; text-align: center;"></div>
        </div>
    </div>

</div>


                        <!--Start of div form-rejected-order!-->
                        <div id='form-rejected-order' class='form-order'>
                        <div class="columns">
                            <div class="column is-3">
                                <div class="field">
                                    <label class="label">Customer Phone</label>
                                    <div class="control">
                                        <input class="input" type="text" id="rejected-order-customer-phone">
                                    </div>
                                </div>
                            </div>
                            <div class="column is-3">
                                <div class="field">
                                    <label class="label">Reason for rejection</label>
                                    <div class="control">
                                        <div class="select" style="width:100%;">
                                            <select id='rejected-order-reason' style="width:100%;">
 
                                            </select>
                                            </div>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-3">
                                <div class="field">
                                    <label class="label">Notes</label>
                                    <div class="control">
                                        <input class="input" type="text" id='rejected-order-note'>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-3">
                                <div class="field">
                                    <label class="label">Where do they know us from?</label>
                                    <div class="control">
                                        <div class="select" style="width:100%;">
                                            <select id='rejected-order-where-know' class='where-know' style="width:100%;">
 
                                            </select>
                                            </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="columns">
                            <div class="column is-3">
                                <a class="button is-primary" id="button-rejected-order">Submit</a>
                            </div>
                        </div>
                        </div> <!--End of div 'form-rejected-order'-->










                    </div>
                </section>
                <div class="modal" id="teams-popup-modal">
  <div class="modal-background modal-close-popup"></div>
  <div class="modal-card" style="width: 800px; max-width: 95vw;">
    <header class="modal-card-head">
      <p class="modal-card-title">Teams assigned to Order: <span id="popup-order-id" class="has-text-weight-bold"></span></p>
      <button class="delete modal-close-popup" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
          <tr>
            <th>Team Name</th>
            <th>Scheduled Time</th>
            <th>Target Service</th>
            <th class="has-text-centered">Actions</th>
          </tr>
        </thead>
        <tbody id="popup-tasks-body">
            </tbody>
      </table>
    </section>
    <footer class="modal-card-foot" style="justify-content: flex-end;">
      <button class="button modal-close-popup">Close</button>
    </footer>
  </div>
</div>

                <hr class="hr" style="margin-bottom: 0;">

                <section class="section">
                    <div class="container">
                        <h1 class="title is-4">Current Orders</h1>
                        <div style="overflow-x: auto;">
                            <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth is-responsive" id="table-current-order">
    <thead>
        <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Time</th>
            <th>Customer Phone</th>
            <th>Customer Name</th>
            <th>Team</th>
            <th>Service</th>
            <th>Notes</th>
            <th>Status</th>
            <th>Generate Invoice</th>
            <th>Edit</th>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>
                        </div>
                    </div>
                </section>

                <!--Start of Modal!-->
                <div class="modal current">
  <div class="modal-background"></div>
  <div class="modal-card" style="width: 850px; max-width: 95vw;">
    
    <header class="modal-card-head">
      <p class="modal-card-title" id="modal-card-title-current-order">Manage Order</p>
      <button class="delete" aria-label="close" id="button-close-modal"></button>
    </header>

    <section class="modal-card-body" style="overflow-y: visible !important; min-height: 450px;">
      
      <h3 class="form-section-header"><i class="fas fa-user"></i> Order & Customer Information</h3>
      <div class="columns is-multiline">
        <div class="column is-3">
          <div class="field">
            <label class="label">Order Date</label>
            <div class="control"><input class="input" type="text" id="edit-order-date" readonly></div>
          </div>
        </div>
        <div class="column is-3">
          <div class="field">
            <label class="label">Customer Name</label>
            <div class="control"><input class="input" type="text" id="edit-order-customer-name"></div>
          </div>
        </div>
        <div class="column is-3">
          <div class="field">
            <label class="label">Phone Number</label>
            <div class="control"><input class="input" type="text" id="edit-order-customer-phone"></div>
          </div>
        </div>
        <div class="column is-3">
          <div class="field">
            <label class="label">Secondary Phone</label>
            <div class="control"><input class="input" type="text" id="edit-order-customer-phone-2"></div>
          </div>
        </div>
      </div>

      <div id="edit-scheduling-section" style="margin-top: 20px;">
        <h3 class="form-section-header"><i class="far fa-calendar-check"></i> Scheduling & Team Assignments</h3>
        <div class="table-container" style="overflow-x: auto; background: #f9f9f9; padding: 10px; border-radius: 6px;">
            <table class="table is-bordered is-fullwidth is-narrow is-hoverable" id="table-edit-assignments">
                <thead class="has-background-white-ter">
                    <tr id="edit-table-header">
                        </tr>
                </thead>
                <tbody id="edit-table-body">
                    </tbody>
            </table>
        </div>
        <button class="button is-small is-info is-outlined" id="btn-edit-add-row">
            <span class="icon is-small"><i class="fas fa-plus"></i></span>
            <span id="btn-edit-row-text">Add Row</span>
        </button>
      </div>

      <hr>

      <h3 class="form-section-header"><i class="fas fa-map-marker-alt"></i> Location & Internal Details</h3>
      <div class="columns is-multiline">
        <div class="column is-6">
          <div class="field">
            <label class="label">Notes</label>
            <div class="control"><input class="input" type="text" id='edit-order-note' placeholder="Gate codes, special instructions..."></div>
          </div>
        </div>
        <div class="column is-6" id="field-edit-status">
          <div class="field">
            <label class="label">Overall Status</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id='edit-order-status'>
                  <option value="Scheduled">Scheduled</option>
                  <option value="Pending payment">Pending Payment</option>
                  <option value="Paid">Paid</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="column is-4">
          <div class="field">
            <label class="label">Address Selection</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id='edit-order-address-select' class='address-select'>
                   </select>
              </div>
            </div>
          </div>
        </div>
        <div class="column is-4">
          <div class="field">
            <label class="label">Address Label</label>
            <div class="control"><input class="input" type="text" id='edit-order-address-label'></div>
          </div>
        </div>
        <div class="column is-4">
          <div class="field">
            <label class="label">Google Maps Link</label>
            <div class="control"><input class="input" type="text" id='edit-order-address-link'></div>
          </div>
        </div>
      </div>

    </section>

    <footer class="modal-card-foot" style="justify-content: flex-end; background-color: #f5f5f5;">
      <button class="button is-success" id="button-save-modal">
        <span class="icon"><i class="fas fa-save"></i></span>
        <span>Save Changes</span>
      </button>
      <button class="button is-info" id="button-convert-modal" style="display:none;">Convert Waitlist</button>
      <button class="button" id="button-cancel-modal">Cancel</button>
    </footer>
  </div>
</div>
                <!--End of Modal!-->

    
                



                <hr class="hr" style="margin-bottom: 0;">

                <!--Start of Waitlist Table!-->

                <section class="section">
                    <div class="container">
                        <h1 class="title is-4">Wait List Orders</h1>
                        <div style="overflow-x: auto;">
                            <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth is-responsive" id="table-waitlist-order">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Customer Phone</th>
                                    <th>Customer Name</th>
                                    <th>Team</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Convert to Order</th>
                                    <th>Cancel</th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </section>

                <!--End of Waitlist Table!-->
                

                <hr class="hr" style="margin-bottom: 100px;"> </div>

            </div>
            <!--End of protected div!-->

        </div>

        <!--End of first page : coordinator!-->

        <div class="page">
            <section class="section">
            <div class="container">
        
            <div class="level is-mobile">
            <div class="level-left">
                <h1 class="title is-4" id='team-selected-after-password'>Current Orders</h1>
            </div>
            <div class="level-right" id="team-logout-container" style="display:none;">
                <button class="button is-danger is-small is-outlined" id="btn-team-logout">
                    <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span>Change Team</span>
                </button>
            </div>
            </div>

            <div class="select" id="team-leader-team-div">
            <select id="team-leader-team">
                <option>Select team</option>
            </select>
            </div>


                    <!--ASK FOR TEAM PASSWORD!-->

                    <div id="password-div-team" style="margin-top:20px;">

                        <label class="label">Please enter team leader password</label>

                        <div class="control">
                            <input class="input" type="password" id='team-password' style="width:270px;">
                        </div>

                        <br>

                        <div>
                            <a class="button is-primary" id="button-submit-password-team">Log in</a>
                        </div>

                    </div>

                    <div id="protected-div-team">

                        <div style="overflow-x: auto;">
                            <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth is-responsive" id="table-team-current-order" style="display: none;">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Customer Phone</th>
                                    <th>Customer Name</th>
                                    <th>Team</th>
                                    <th>Service</th>
                                    <th>Notes</th>
                                    <th>Status</th>
                                    <th>Address Link</th>
                                    <th>Generate Invoice</th>
                                </tr>
                            </table>
                        </div>


                        



                          <div class="columns">
                            <div class="column is-full" id='column-team-current-order' style="display: block;">


                              <div class="card card-team">
                                <header class="card-header" style="background-color: #f7901e; border-radius: 6px">
                                  <p class="card-header-title">
                                    1 January 2022
                                  </p>
                                </header>
                              </div>

                              <div class="card card-team">
                                <header class="card-header" style="background-color: #414042;border-radius: 6px 6px 0px 0px;">
                                  <p class="card-header-title">
                                    8.00 AM
                                  </p>
                                </header>
                                <div class="card-content">
                                  <div class="content">
                                    <table class="table is-fullwidth is-responsive">
                                        <tr>
                                            <td><b>Order Number</b></td>
                                            <td>RSH/N/2022/01/0148</td>
                                        </tr>
                                        <tr>
                                            <td><b>Phone Number</b></td>
                                            <td>0132820607</td>
                                        </tr>
                                        <tr>
                                            <td><b>Name</b></td>
                                            <td>Aiman Izzat</td>
                                        </tr>
                                        <tr>
                                            <td><b>Team</b></td>
                                            <td>Team 1, Team 2</td>
                                        </tr>
                                        <tr>
                                            <td><b>Service Type</b></td>
                                            <td>Filter</td>
                                        </tr>
                                        <tr>
                                            <td><b>Notes</b></td>
                                            <td>Change 3 filter</td>
                                        </tr>
                                    </table>
                                  </div>
                                </div>
                                <footer class="card-footer">
                                  <a href="#" class="card-footer-item">Google Maps</a>
                                  <a href="#" class="card-footer-item">Generate Invoice</a>
                                </footer>
                              </div>

                            
                              <div class="card card-team">
                                <header class="card-header" style="background-color: #414042;border-radius: 6px 6px 0px 0px;">
                                  <p class="card-header-title">
                                    8.00 AM
                                  </p>
                                </header>
                                <div class="card-content">
                                  <div class="content">
                                    <table class="table is-fullwidth is-responsive">
                                        <tr>
                                            <td><b>Order Number</b></td>
                                            <td>RSH/N/2022/01/0148</td>
                                        </tr>
                                        <tr>
                                            <td><b>Phone Number</b></td>
                                            <td>0132820607</td>
                                        </tr>
                                        <tr>
                                            <td><b>Name</b></td>
                                            <td>Aiman Izzat</td>
                                        </tr>
                                        <tr>
                                            <td><b>Team</b></td>
                                            <td>Team 1, Team 2</td>
                                        </tr>
                                        <tr>
                                            <td><b>Service Type</b></td>
                                            <td>Filter</td>
                                        </tr>
                                        <tr>
                                            <td><b>Notes</b></td>
                                            <td>Change 3 filter</td>
                                        </tr>
                                    </table>
                                  </div>
                                </div>
                                <footer class="card-footer">
                                  <a href="#" class="card-footer-item">Google Maps</a>
                                  <a href="#" class="card-footer-item">Generate Invoice</a>
                                </footer>
                              </div>

                            </div>
                          </div>


                 

                    <!--START OF INVOICE!-->
                    <div class="invoice-box" style="display:none;">

    <div id="view-daily-entry" style="display:none;">

    <div class="dark-header">
        <div style="display:flex; align-items:center; margin-bottom: 5px;">
            <span style="color:#00d1b2; font-size:1.5rem; margin-right:10px;"></span>
            <h2 class="title is-5" style="color: white; margin:0;">Daily Entry</h2>
        </div>
        <div class="columns is-mobile is-multiline" style="border-top: 1px solid #1F2937; padding-top:20px; margin-top:15px;">
            <div class="column is-3">
                <strong style="color:#6B7280; font-size:0.7rem;">ORDER NUMBER</strong><br>
                <span id="entry-order-num" style="color:white; font-weight:bold;">-</span>
            </div>
            <div class="column is-3">
                <strong style="color:#6B7280; font-size:0.7rem;">CUSTOMER NAME</strong><br>
                <span id="entry-cust-name" style="color:white; font-weight:bold;">-</span>
            </div>
            <div class="column is-3">
                <strong style="color:#6B7280; font-size:0.7rem;">CUSTOMER PHONE</strong><br>
                <span id="entry-cust-phone" style="color:white; font-weight:bold;">-</span>
            </div>
            <div class="column is-3">
                <strong style="color:#6B7280; font-size:0.7rem;">TEAM</strong><br>
                <span id="entry-team" style="color:white;">-</span>
            </div>
        </div>
      </div>
    <div class="invoice-card" style="border-radius: 0 0 12px 12px; border-top: none; margin-top: 0;">
        
        <h2 class="card-heading">Services</h2>

        <table class="clean-table" id="table-invoice-item">
            <thead>
                <tr>
                    <th style="width:28%">Main</th>
                    <th style="width:20%">Sub</th>
                    <th style="width:20%">Sub</th>
                    <th style="width:15%">Qty</th>
                    <th style="width:17%; text-align:right;">Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input class="input chip-input" type="text" name="main" id="1-main" placeholder="Main service"></td>
                    <td><input class="input chip-input" type="text" name="sub1" id="1-sub1" placeholder="Sub category"></td>
                    <td><input class="input chip-input" type="text" name="sub2" id="1-sub2" placeholder="Sub category"></td>
                    <td>
                        <div style="display:flex; align-items:center;">
                            <input class="input chip-input" type="text" name="qty" id="1-qty" placeholder="0" style="text-align:center;">
                            <span id='1-unit' style="margin-left:5px; font-size:0.8rem; font-weight:600; color:#6B7280; display:none;"></span>
                        </div>
                    </td>
                    <td name="total" id="1-total" style="text-align: right; font-weight: 800; color:#111827; font-size:1.1rem; padding-top:10px;">0.00</td>
                </tr>
            </tbody>
        </table>

        <div id="button-add-row" class="dashed-add-btn">
            <span class="icon is-small"><i class="fas fa-plus"></i></span>
            <span>Add Service</span>
        </div>

        <div class="footer-box">
            <div>
                <span class="total-label">GRAND TOTAL</span>
                <span id="entry-grand-total" class="total-value">0.00</span>
                <span id="total-amount" style="display:none;">0</span>
                
                <span id="services-subtotal" style="display:none;">0</span>
                <span id="spare-subtotal" style="display:none;">0</span>
                <span id="location-subtotal" style="display:none;">0</span>
                <span id="discount-subtotal" style="display:none;">0</span>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="button teal-btn" id="btn-goto-summary" style="background-color: #1F2937 !important;">
                    <span>Next</span>
                    <span class="icon is-small" style="margin-left: 5px;"><i class="fas fa-chevron-right"></i></span>
                </button>
            </div>
        </div>

        <div id="financial-sections" style="display:none;">
             <div id="section-spare-parts"></div>
             <div id="section-address"></div>
             <div id="section-billing"></div>
        </div>

    </div>
</div>


    <div id="view-daily-summary" style="display:none;">
        
        <div class="dark-header">
            <div style="display:flex; align-items:center; margin-bottom: 5px;">
                <span style="color:#00d1b2; font-size:1.5rem; margin-right:10px;"></span>
                <h2 class="title is-5" style="color: white; margin:0;">Services Summary</h2>
            </div>
            <p style="color: #9CA3AF;">Review your services before submitting</p>
            
            <div class="columns is-mobile is-multiline" style="border-top: 1px solid #1F2937; padding-top:20px; margin-top:15px;">
                <div class="column is-3">
                    <strong style="color:#6B7280; font-size:0.7rem;">ORDER NUMBER</strong><br>
                    <span id="sum-order-id" style="color:white; font-weight:bold;">-</span>
                </div>
                <div class="column is-3">
                    <strong style="color:#6B7280; font-size:0.7rem;">CUSTOMER NAME</strong><br>
                    <span id="sum-cust-name" style="color:white; font-weight:bold;">-</span>
                </div>
                <div class="column is-3">
                    <strong style="color:#6B7280; font-size:0.7rem;">CUSTOMER PHONE</strong><br>
                    <span id="sum-cust-phone" style="color:white; font-weight:bold;">-</span>
                </div>
                <div class="column is-3">
                    <strong style="color:#6B7280; font-size:0.7rem;">TEAM</strong><br>
                    <span id="sum-team" style="color:white;">-</span>
                </div>
            </div>
        </div>

        <div style="background: white; padding: 30px; border: 1px solid #E5E7EB; border-top: none; border-radius: 0 0 12px 12px;">
             
             <table class="table is-fullwidth" style="margin-bottom: 30px;">
                <thead>
                    <tr style="border-bottom: 2px solid #F3F4F6;">
                        <th style="color:#6B7280;">Main</th>
                        <th style="color:#6B7280;">Sub</th>
                        <th style="color:#6B7280;">Sub</th>
                        <th style="color:#6B7280; text-align:center;">Qty</th>
                        <th style="color:#6B7280; text-align:right;">Total</th>
                    </tr>
                </thead>
                <tbody id="summary-table-body" style="font-size: 0.95rem; color:#374151;">
                    </tbody>
             </table>

             <div class="level is-mobile" style="border-top: 1px solid #F3F4F6; padding-top:20px;">
                <div class="level-left">
                    <button class="button" id="btn-summary-back" style="border-radius:8px; border-color:#E5E7EB;">
                        <span class="icon"><i class="fas fa-arrow-left"></i></span>
                        <span>Back</span>
                    </button>
                </div>
                <div class="level-right" style="align-items: center;">
                    <div style="margin-right: 30px; text-align:right;">
                        <span style="color:#6B7280; font-size:0.85rem; font-weight:600; text-transform:uppercase;">Grand Total</span>
                        <span id="sum-grand-total" style="display:block; font-size:1.8rem; font-weight:bold; line-height:1;">0.00</span>
                    </div>
                    <button class="button is-success" id="btn-summary-submit" style="background-color: #10B981; border-radius:8px; font-weight:bold; padding: 25px 30px; border:none;">
                        <span class="icon"><i class="fas fa-check"></i></span>
                        <span>Submit Services</span>
                    </button>
                </div>
             </div>
             <div id="msg-daily-submit" class="notification is-success is-light" style="display:none; margin-top: 20px; text-align: center;"></div>
        </div>
    </div>
    <div id="view-final-invoice" style="display:none;">
    
    <div class="dark-header" style="background-color: #0B1120; color: white; padding: 20px 30px; border-radius: 12px 12px 0 0; display:flex; align-items:center;">
        <span style="color:#00d1b2; font-size:1.5rem; margin-right:10px;"></span>
        <h2 class="title is-5" style="color: white; margin:0;">Final Details</h2>
        <span style="margin-left:auto; font-size:0.9rem; color:#9CA3AF;">Add spare part & payment info</span>
    </div>

    <div style="background: white; padding: 30px; border: 1px solid #E5E7EB; border-top: none; border-radius: 0 0 12px 12px;">
        <div class="columns">
            
            <div class="column is-8" style="padding-right: 40px; border-right: 1px solid #F3F4F6;">
                
                <h4 class="label" style="color:#374151; font-weight:700;">Submitted Services</h4>
                <table class="table is-fullwidth clean-table" style="margin-bottom:30px;">
                    <thead>
                        <tr style="border-bottom: 2px solid #F3F4F6;">
                            <th style="color:#9CA3AF; font-weight:500;">Main</th>
                            <th style="color:#9CA3AF; font-weight:500;">Sub</th>
                            <th style="color:#9CA3AF; font-weight:500;">Sub</th>
                            <th style="color:#9CA3AF; font-weight:500;">Qty</th>
                            <th style="color:#9CA3AF; font-weight:500; text-align:right;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="final-invoice-services-body">
                        </tbody>
                </table>

                <h4 class="label" style="color:#374151; font-weight:700;">Spare Part</h4>
                <div class="columns">
                    <div class="column is-6">
                        <label class="label" style="font-size:0.85rem; color:#6B7280;">Total Cost</label>
                        <div class="control has-icons-right">
                            <input class="input chip-input" type="number" id="spare-part-cost" placeholder="0.00">
                            <span class="icon is-small is-right" style="color:#9CA3AF; padding-right:10px; pointer-events:none; line-height:2.5rem;">QAR</span>
                        </div>
                    </div>
                    <div class="column is-6">
                        <label class="label" style="font-size:0.85rem; color:#6B7280;">Description (Optional)</label>
                        <input class="input chip-input" type="text" placeholder="Enter value">
                    </div>
                </div>

                <div class="field" style="margin-bottom: 30px;">
                    <label class="label" style="font-size:0.85rem; color:#6B7280;">Photo</label>
                    <div class="file is-success is-outlined">
                        <label class="file-label" style="width:100%;">
                            <input class="file-input" type="file" id="button-add-photo">
                            <span class="file-cta" style="width: 150px; justify-content: center; border: 1px dashed #10B981; background: #ECFDF5; border-radius: 6px;">
                                <span class="file-icon"><i class="fas fa-upload"></i></span>
                                <span class="file-label">Add Photo</span>
                            </span>
                        </label>
                        <span id="photo-name" style="margin-left:10px; align-self:center; font-size:0.9rem;"></span>
                    </div>
                </div>

                <h4 class="label" style="color:#374151; font-weight:700;">Address</h4>
                <div class="columns">
                    <div class="column is-4">
                        <label class="label" style="font-size:0.85rem; color:#6B7280;">Building</label>
                        <input class="input chip-input" type="text" id="building" placeholder="No.">
                    </div>
                    <div class="column is-4">
                        <label class="label" style="font-size:0.85rem; color:#6B7280;">Street</label>
                        <input class="input chip-input" type="text" id="street" placeholder="Name">
                    </div>
                    <div class="column is-4">
                        <label class="label" style="font-size:0.85rem; color:#6B7280;">Zone</label>
                        <input class="input chip-input" type="text" id="zone" placeholder="No.">
                    </div>
                </div>

                <h4 class="label" style="color:#374151; font-weight:700; margin-top:20px;">Charges & Discounts</h4>
                <div class="columns">
                    <div class="column is-6">
                         <label class="label" style="font-size:0.85rem; color:#6B7280;">Location Charge</label>
                        <div class="control has-icons-right">
                            <input class="input chip-input" type="number" id="location-charge" placeholder="0.00">
                            <span class="icon is-small is-right" style="color:#9CA3AF; padding-right:10px; pointer-events:none; line-height:2.5rem;">QAR</span>
                        </div>
                    </div>
                    <div class="column is-6">
                        <label class="label" style="font-size:0.85rem; color:#6B7280;">Discount</label>
                        <div class="control has-icons-right">
                            <input class="input chip-input" type="number" id="discount" placeholder="0.00">
                            <span class="icon is-small is-right" style="color:#9CA3AF; padding-right:10px; pointer-events:none; line-height:2.5rem;">QAR</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column is-4" style="display:flex; flex-direction:column;">
                
                <div style="background: #F9FAFB; padding: 25px; border-radius: 12px; height: 100%;">
                    <h4 class="label" style="color:#111827; font-size:1.1rem; margin-bottom:20px;">Summary</h4>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#6B7280; font-size:0.9rem;">
                        <span>Services</span>
                        <span id="final-services-subtotal">0.00</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#6B7280; font-size:0.9rem;">
                        <span>Spare Parts</span>
                        <span id="final-spare-subtotal">0.00</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#6B7280; font-size:0.9rem;">
                        <span>Location</span>
                        <span id="final-location-subtotal">0.00</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:#6B7280; font-size:0.9rem; border-bottom:1px solid #E5E7EB; padding-bottom:15px;">
                        <span>Discount</span>
                        <span id="final-discount-subtotal">0.00</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom:30px; color:#111827; font-weight:800; font-size:1.2rem;">
                        <span>TOTAL</span>
                        <span id="final-total-amount">0.00</span>
                    </div>

                    <div style="background:white; border:1px solid #E5E7EB; border-radius:8px; padding:15px; margin-bottom:20px;">
                        <label class="label" style="font-size:0.85rem; color:#6B7280; margin-bottom:10px;">Payment Status</label>
                        
                        <div class="control">
                            <label class="radio" style="display:flex; align-items:center; padding: 5px 0; cursor:pointer;">
                                <input type="radio" name="payment-status" value="Paid-Cash" style="margin-right:10px;"> Paid - Cash
                            </label>
                            <label class="radio" style="display:flex; align-items:center; padding: 5px 0; cursor:pointer;">
                                <input type="radio" name="payment-status" value="Paid-POS" style="margin-right:10px;"> Paid - POS
                            </label>
                            <label class="radio" style="display:flex; align-items:center; padding: 5px 0; cursor:pointer;">
                                <input type="radio" name="payment-status" value="Pending Payment" style="margin-right:10px;" checked> Pending Payment
                            </label>
                            <label class="radio" style="display:flex; align-items:center; padding: 5px 0; cursor:pointer;">
                                <input type="radio" name="payment-status" value="Customer Cancelled Job" style="margin-right:10px;"> Cancelled Job
                            </label>
                        </div>
                    </div>

                    <button class="button is-info is-fullwidth" id="btn-real-submit-invoice" style="background-color: #00d1b2 !important; font-weight:700; height:50px; box-shadow: 0 4px 6px rgba(0, 209, 178, 0.2);">
                        Submit Invoice
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>
   
                    <!--End of protected-div-team !-->

                </div>
                <!--Container !-->

            </section>

        </div>
        <!--End of second page : team leader !-->


        <!--Start of third page : Pending Payment !-->
        <div class="page">

            <!--ASK FOR PENDING PAYMENT PASSWORD!-->

            <div id="password-div-pending-payment" style="margin-top:50px;padding:1rem">

                <label class="label">Please enter pending payment password</label>

                <div class="control">
                    <input class="input" type="password" id='pending-payment-password' style="width:270px;">
                </div>

                <br>

                <div>
                    <a class="button is-primary" id="button-submit-password-pending-payment">Log in</a>
                </div>

            </div>

            <div id="protected-div-pending-payment">

                <section class="section">
                    <div class="container">
                        <h1 class="title is-4">Pending Payment Orders</h1>
                        <div style="overflow-x: auto;">
                            <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth is-responsive" id="table-pending-payment-order" style="font-size: small;">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Customer Phone</th>
                                    <th>Customer Name</th>
                                    <th>Team</th>
                                    <th>Service</th>
                                    <th>Total Charge</th>
                                    <th>Status</th>
                                    <th>Invoice</th>
                                    <th>Paid Cash</th>
                                    <th>Paid POS</th>
                                    <th>Paid Transfer</th>
                                    <th>Paid Cheque</th>
                                    <th>Paid Payment Link</th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </section>
                

                <hr class="hr" style="margin-bottom: 100px;">

            </div>
            <!--End of protected div!-->

        </div>

        <!--End of third page : pending payment!-->







        <!--Start of fourth page : Completed Orders !-->
        <div class="page">

            <!--ASK FOR COMPLETED ORDERS PASSWORD!-->

            <div id="password-div-completed-orders" style="margin-top:50px;padding:1rem">

                <label class="label">Please enter completed orders password</label>

                <div class="control">
                    <input class="input" type="password" id='completed-orders-password' style="width:270px;">
                </div>

                <br>

                <div>
                    <a class="button is-primary" id="button-submit-password-completed-orders">Log in</a>
                </div>

            </div>

            <div id="protected-div-completed-orders">

                <section class="section">
                    <div class="container">
                        <h1 class="title is-4">Completed Orders</h1>
                        <div style="overflow-x: auto;">
                            <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth is-responsive" id="table-completed-order">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Customer Phone</th>
                                    <th>Customer Name</th>
                                    <th>Team</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Invoice</th>
                                    <th>Edit</th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </section>
                
                
                
                <!--Start of Modal!-->

                <div class="modal completed">
                    <div class="modal-background"></div>

                    <div class="modal-card">

                        <header class="modal-card-head">
                            <p class="modal-card-title" id="modal-card-title-completed-order">Edit Order</p>
                            <button class="delete" aria-label="close" id="button-close-modal-completed-order"></button>
                        </header>

                        <section class="modal-card-body">

                            <div class="container" id="container-edit-order" style="width:250px;">

                                <div class="field">
                                    <label class="label">Status</label>
                                    <div class="control">
                                        <div class="select">
                                            <select id='edit-completed-order-status'>
                                                <option value="None" selected>Select new status</option>
                                                <option value="Paid Cash">Paid-Cash</option>
                                                <option value="Paid POS">Paid-POS</option>
                                                <option value="Pending Payment">Pending Payment</option>
                                                <option value="Customer Cancelled">Customer Cancelled Job</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </section>

                        <footer class="modal-card-foot">

                            <button class="button is-primary" id="button-save-modal-completed-order">Save Changes</button>
                            <button class="button" id="button-cancel-modal-completed-order">Cancel</button>

                        </footer>
                    </div>

                </div>
                <!--End of Modal!-->

                <hr class="hr" style="margin-bottom: 100px;">

            </div>
            <!--End of protected div!-->

        </div>

        <!--End of fourth page : Completed Orders!-->







   


    </div>
    <!--Container !-->

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.1/js/standalone/selectize.min.js"></script>


<script>
    var globalBackendData = [];
    var isFinalInvoiceMode = false;
    $(function() {
    
         getAutoCompleteList();

        $('.form-order').hide();
        $('#form-past-booking').hide();
        
        $('.page').hide().eq(0).show();

        $("#tabs li").click(function() {

            $('#tabs li').removeClass('is-active');
            $(this).addClass('is-active');

            $('.page').hide().eq($(this).index()).show();

            // 2. FORCE HIDE specific UI elements that might leak
            $('.invoice-box').hide();      // Hide invoice box
            $('.form-order').hide();       // Hide all order forms (Multi-day, Normal, etc)
            $('#form-past-booking').hide();// Hide past booking search
    
            // 3. Reset dropdowns if necessary (Optional)
            $('#select-order-type').val('Please Select');

        });

        // 1. "Next" Button (Step 1 -> Step 2)
        $("#btn-goto-summary").unbind("click").click(function() {
            showSummaryView();
        });

        // 2. "Back" Button (Step 2 -> Step 1)
        $("#btn-summary-back").unbind("click").click(function() {
            $("#view-daily-summary").hide();
            $("#view-daily-entry").fadeIn();
        });

        // 3. "Submit Services" Button (Step 2 -> Backend)
    $("#btn-summary-submit").unbind("click").click(function() {
    
    if (isFinalInvoiceMode === false) {
        // --- SCENARIO 1: DAILY LOG (Partial) ---
        // Submit immediately to backend
        $(this).addClass('is-loading');
        submitDailyWork();
        
    } else {
        // --- SCENARIO 2: FINAL INVOICE ---
        // Do NOT submit yet. Move to Step 3 (Spare Parts/Payment).
        
        // 1. Copy services from Step 1 to the Final View Read-Only Table
        var finalBody = $("#final-invoice-services-body");
        finalBody.empty();
        
        $('#table-invoice-item tr').each(function(i) {
            if (i > 0) { // Skip header
                var main = $(this).find("input[name='main']").val();
                var sub1 = $(this).find("input[name='sub1']").val();
                var sub2 = $(this).find("input[name='sub2']").val();
                var qty = $(this).find("input[name='qty']").val();
                var unit = $(this).find("span[id$='-unit']").text();
                var total = $(this).find("td[name='total']").text();

                if (main) {
                    var rowHtml = `
                    <tr style="border-bottom: 1px solid #f5f5f5;">
                        <td>${main}</td>
                        <td>${sub1}</td>
                        <td>${sub2}</td>
                        <td>${qty} ${unit}</td>
                        <td style="text-align:right;">${total}</td>
                    </tr>`;
                    finalBody.append(rowHtml);
                }
            }
        });

       // 2. Switch Views
        $("#view-daily-summary").hide();
        $("#view-final-invoice").fadeIn(); 
        
        // Show the inputs needed for final invoice
        $("#view-daily-entry").show(); 
        $("#financial-sections").show(); 
        $("#section-payment-method").show();
        $("#button-submit-final").show(); 
        
        // Hide the intermediate buttons
        $("#btn-goto-summary").hide();
        $(".dark-header").hide(); // Hide daily header, show final header
        
        $(".invoice-box")[0].scrollIntoView({behavior: "smooth"});
    }
});
        $('#btn-add-assignment-row').click(function() {
            addAssignmentRow();
        });
        // FIX FOR EDIT MODAL: Handle adding rows for both Normal and Multi-day orders
        $('#btn-edit-add-row').unbind("click").click(function() {
            var title = $('#modal-card-title-current-order').text();
            var isMultiDay = title.indexOf("/MD/") !== -1;
            
            // Add a blank row with default times
            addEditRow(isMultiDay, {
                team: "Select team", 
                service: "", 
                date: "", 
                startT: "9:00 AM", 
                endT: "10:00 AM"
            });
        });
        // 4. "Generate Invoice" Button (Final Step -> Backend)
        $("#btn-real-submit-invoice").unbind("click").click(function() {
            $(this).addClass('is-loading');
            submitInvoice();
        });
        
        // 5. Add Service Row
        $(document).on("click", "#button-add-row", function() {
            var rowCount = $('#table-invoice-item tr').length;
            
            var newRowHtml = '<tr>' +
                '<td><input class="input chip-input main" type="text" name="main" id="' + rowCount + '-main" placeholder="Main service"></td>' +
                '<td><input class="input chip-input" type="text" name="sub1" id="' + rowCount + '-sub1" placeholder="Sub category"></td>' +
                '<td><input class="input chip-input" type="text" name="sub2" id="' + rowCount + '-sub2" placeholder="Sub category"></td>' +
                '<td>' +
                    '<div style="display:flex; align-items:center;">' +
                        '<input class="input chip-input" type="text" name="qty" id="' + rowCount + '-qty" style="text-align:center;" placeholder="0" autocomplete="nope">' +
                        '<span id="' + rowCount + '-unit" style="margin-left:5px; font-size:0.8rem; font-weight:600; color:#6B7280; display:none;"></span>' +
                    '</div>' +
                '</td>' +
                '<td name="total" id="' + rowCount + '-total" style="text-align: right; font-weight: 800; color:#111827; font-size:1.1rem; padding-top:10px;">0.00</td>' +
                '</tr>';

            $('#table-invoice-item tbody').append(newRowHtml);
            addAutoCompleteToNewRow($('#' + rowCount + '-main'), rowCount);
        });

        //Hide and protect coordinator page with password
        $('#protected-div').hide();


        // --- COORDINATOR LOGIN LOGIC ---
        $("#button-submit-password").click(function() {

            var enteredPassword = $("#coordinator-password").val();

            google.script.run
                .withSuccessHandler(
                    function(passwordCorrect) {

                        if (passwordCorrect) {

                            $('#password-div').remove();
                            $('#protected-div').show();

                            // *** NEW: ONLY RENDER TABLES AFTER PASSWORD IS CORRECT ***
                            renderCoordinatorTables(); 

                            //Get the calendar after the div is visible
                            getCalendarEvent('','');

                        } else {
                            showError("Sorry, the password entered is incorrect.", $('#button-submit-password'));
                        }

                    })
                .gasCheckCoordinatorPassword(enteredPassword);

        });

        // GLOBAL EDIT LISTENER - PLACE THIS OUTSIDE OF ANY OTHER FUNCTION
$(document).on('click', '.editCurrentOrder', function(e) {
    e.preventDefault();
    var idAttr = $(this).attr("id"); 
    if (!idAttr) return;

    var parts = idAttr.split("**");
    var orderId = parts[1];
    var rowDate = parts[2]; // This passes the specific dateId for matching
    
    var type = $(this).hasClass('convertWaitlistButton') ? "waitlist" : "current";

    $(this).addClass('is-loading');
    var btn = $(this);

    // Call the function to fetch data and fill the form
    fillUpEditFormWithExistingData(orderId, type, rowDate);
    
    // Safety release of spinner
    setTimeout(function(){ btn.removeClass('is-loading'); }, 4000);
});
$("#add-order-date, #edit-order-date").datepicker({ 
    dateFormat: 'mm/dd/yy' 
});


       // --- NEW LOGOUT LOGIC (FIXED) ---
$("#btn-team-logout").unbind("click").click(function() {
    // 1. Hide Content & Logout Button
    $('#protected-div-team').hide();
    $('#team-logout-container').hide();

    // 2. Clear Input Fields
    $('#team-password').val(''); 
    $('#team-leader-team').val('Select team'); // Reset dropdown
    
    // 3. Reset UI State (Header)
    $('#password-div-team').hide();        // Hide password box
    $('#team-leader-team-div').show();     // Show team selector
    $('#team-selected-after-password').text('Current Orders'); // Reset title

    // --- FIX START: WIPE STALE DATA ---
    
    // 4. Force Close Invoice/Daily Views
    $('.invoice-box').hide();
    $("#view-daily-entry").hide();
    $("#view-daily-summary").hide();
    $("#view-final-invoice").hide();
    $(".modal").removeClass('is-active'); // Close any open modals

    // 5. Clear Stale Data Variables
    $("#entry-team").text("-");
    $("#text-customer-name").text("");
    $("#text-order-num").text("");
    
    // 6. Clear the Table Rows immediately (so Team 1 doesn't see Team 2's rows for a split second)
    $("#table-team-current-order").find("tr:gt(0)").remove();
    
    // 7. Clear the Invoice Form Inputs
    clearInvoice(true);

    // --- FIX END ---
});
        //End of coordinator page password protect

        //Hide and protect team page with password
        $('#protected-div-team').hide();
        $('#password-div-team').hide();

        $("#button-submit-password-team").click(function() {

            var enteredPassword = $("#team-password").val();
            var teamSelected = $("#team-leader-team").val();

            google.script.run
                .withSuccessHandler(
                    function(result) {

                        if (result[0]) {

                            $('#password-div-team').hide();        // Hide password
                            $("#team-leader-team-div").hide();     // Hide selector
                            $('#protected-div-team').show();       // Show content
                            $('#team-logout-container').show();    // <--- SHOW LOGOUT BUTTON
                            $('#team-selected-after-password').text(result[1]);
                            getTableTeamCurrentOrder(result[1]);

                        } else {
                            showError("Sorry, the password entered is incorrect.", $('#button-submit-password-team'));
                        }

                    })
                .gasCheckTeamLeaderPassword(teamSelected, enteredPassword);

        });

        //End of coordinator page password protect

        // --- PENDING PAYMENT LOGIN LOGIC ---
        $('#protected-div-pending-payment').hide();

        $("#button-submit-password-pending-payment").click(function() {

            var enteredPassword = $("#pending-payment-password").val();

            google.script.run
                .withSuccessHandler(
                    function(passwordCorrect) {

                        if (passwordCorrect) {

                            $('#password-div-pending-payment').remove();
                            $('#protected-div-pending-payment').show();
                            
                            // *** NEW: ONLY RENDER TABLES AFTER PASSWORD IS CORRECT ***
                            renderPendingPaymentTables();

                        } else {
                            showError("Sorry, the password entered is incorrect.", $('#button-submit-password-pending-payment'));
                        }

                    })
                .gasCheckPendingPaymentPassword(enteredPassword);

        });

        // --- COMPLETED ORDERS LOGIN LOGIC ---
        $('#protected-div-completed-orders').hide();

        $("#button-submit-password-completed-orders").click(function() {

            var enteredPassword = $("#completed-orders-password").val();

            google.script.run
                .withSuccessHandler(
                    function(passwordCorrect) {

                        if (passwordCorrect) {

                            $('#password-div-completed-orders').remove();
                            $('#protected-div-completed-orders').show();
                            
                            // *** NEW: ONLY RENDER TABLES AFTER PASSWORD IS CORRECT ***
                            renderCompletedTables();

                        } else {
                            showError("Sorry, the password entered is incorrect.", $('#button-submit-password-completed-orders'));
                        }

                    })
                .gasCheckCompletedOrdersPassword(enteredPassword);

        });





        //End of team page password protect


        $('#button-add-order').click(function() { addOrder(false); });
        $('#button-add-order-ignore-conflict').click(function() { addOrder(true); });        
        $('#button-rejected-order').click(addRejectedOrder);
        $("#add-order-date,#edit-order-date").datepicker();

        $("#1-qty").change(function() {

            //Once the qty get entered, calculate the subtotal
            var main = $("#1-main").val();
            var sub1 = $("#1-sub1").val();
            var sub2 = $("#1-sub2").val();
            var qty = $("#1-qty").val();

            calculateServiceCost(main, sub1, sub2, qty, "1");

        });

        $('#button-add-photo').change(function(e) {

            var fileName = e.target.files[0].name;

            $('#photo-name').empty();
            $('#photo-name').append(fileName);

        });

       $("#button-convert-modal").click(function() {

            $('#cover-spin').show();

            $(".modal.current").removeClass('is-active');

            convertWaitlistOrder();

        });

        $('#spare-part-cost, #location-charge, #discount').on('input', function() {
            calculateTotalCost();
        });


       $('#select-order-type').change(function() {
            var selectedOrderType = $('#select-order-type').val();
            $('.form-order').hide();
            $('#form-past-booking').hide();
            $('#add-order-where-know-field').show();
            $('#add-order-address-select-field').show();

            if(selectedOrderType == 'Normal Order' || selectedOrderType == 'Wait List'){
                 $('#form-normal-order').show();
            } else if (selectedOrderType == 'Multi-day Order') {
                 $('#form-multiday-order').show();
                 if ($('#table-multiday-dates tbody tr').length === 0) { addMultidayRow(); }
            } else if(selectedOrderType == 'Back Order'){
                 $('#form-past-booking').show();
                 $('#add-order-where-know-field').hide();
                 $('#add-order-address-select-field').hide();
            } else if(selectedOrderType == 'Rejected Order'){
                 $('#form-rejected-order').show();
            }
        });


       $('#add-order-address-select').change(function() {
            var selectedAddressLabel = $(this).val();
            if(selectedAddressLabel == 'Please Select' || selectedAddressLabel == 'newaddress'){
              $('#add-order-address-label').val('');
              $('#add-order-address-link').val('');
            } else {
              var split = selectedAddressLabel.split("***");
              $('#add-order-address-label').val(split[1]);
              getAddressLink(split[0],split[1],"addOrder");
            }
        });
       // --- UPDATED: Multi-day Address Change Listener ---
        $('#multiday-address-select').change(function() {
        var selectedAddressLabel = $(this).val();
        
        if (selectedAddressLabel == 'Please Select' || selectedAddressLabel == 'newaddress') {
            $('#multiday-address-label').val('');
            $('#multiday-address-link').val('');
        } else {
            var split = selectedAddressLabel.split("***");
            var phone = split[0];
            var label = split[1];
            
            // Set Label
            $('#multiday-address-label').val(label);
            
            // Show "Loading" so the user knows it's working
            $('#multiday-address-link').val("Fetching link...");
            $('#multiday-address-link').addClass("is-loading"); // Bulma loading style
            
            // Fetch Link
            getAddressLink(phone, label, "multiday");
        }
    });



       $('#edit-order-address-select').change(function() {
            var selectedAddressLabel = $(this).val();
            if(selectedAddressLabel == 'Please Select' || selectedAddressLabel == 'newaddress'){
              $('#edit-order-address-label').val('');
              $('#edit-order-address-link').val('');
            } else {
              var split = selectedAddressLabel.split("***");
              $('#edit-order-address-label').val(split[1]);
              getAddressLink(split[0],split[1],"editOrder");
            }
        });


     $("#button-save-modal").click(function() {
            $('#cover-spin').show();
            $(".modal.current").removeClass('is-active');
            updateOrder();
        });
      
      $(document).on('click', '#button-close-modal, #button-cancel-modal', function() {
            $(".modal.current").removeClass('is-active');
            $("#edit-order-date").removeClass("timingChanged");
            $("#edit-order-time").removeClass("timingChanged");
        });
        $("#button-close-modal-conflict,#button-cancel-modal-conflict").click(function() {
            $(".modal.conflict").removeClass('is-active');
        });

        

    });

    $(document).ready(function() {
        var onDateSelect = function(dateText) { loadDailySchedule(dateText); };
        $("#schedule-date-picker").datepicker({ dateFormat: 'd M yy', onSelect: onDateSelect }).datepicker("setDate", new Date());
        loadDailySchedule($("#schedule-date-picker").val());
    });

    function loadDailySchedule(date) {
        showError('<progress class="progress is-small is-info" max="100"></progress>', '#btn-load-schedule');
        
        google.script.run
            .withSuccessHandler(renderScheduleView)
            .withFailureHandler(function(err){ alert(err); })
            .gasGetOrdersForDate(date);
    }

    function renderScheduleView(data) {
    if (!data || !data.teams || data.teams.length === 0) {
        $('#error').remove(); 
        $("#schedule-rows").html('<div class="notification is-danger has-text-centered">No Team Data Found.</div>');
        return;
    }
    $('#error').remove(); 
    $("#schedule-container").show();
    $(".schedule-header-group").remove();
    $("#schedule-rows").empty();
    $("#schedule-header-row").remove(); // Remove old header logic if exists

    var teams = data.teams;
    var orders = data.orders;

    // --- 1. CONFIGURATION ---
    var startHour = 5; // 05:00 AM
    var endHour = 23;  // 11:00 PM
    var totalHours = endHour - startHour;
    var totalMinutes = totalHours * 60; 
    
    // --- 2. BUILD NEW HEADER STRUCTURE ---
    var headerHtml = `
    <div class="schedule-header-group">
        <div class="shift-header-row">
            <div class="shift-block shift-morning" style="flex: 4.5;">Morning Shift (05:00 - 09:30)</div>
            <div class="shift-block shift-afternoon" style="flex: 3;">Afternoon (09:30 - 12:30)</div>
            <div class="shift-block shift-evening" style="flex: 5.5;">Evening (12:30 - 06:00)</div>
            <div class="shift-block shift-night" style="flex: 5;">Night (06:00 - 11:00)</div>
        </div>
        <div class="time-header-row">`;
    
    for (var h = startHour; h < endHour; h++) {
        var ampm = h >= 12 ? "PM" : "AM";
        var dispH = h > 12 ? h - 12 : h;
        // Hour
        headerHtml += `<div class="header-time-slot">${dispH}:00 ${ampm}</div>`;
        // Half Hour
        headerHtml += `<div class="header-time-slot">${dispH}:30 ${ampm}</div>`;
    }
    headerHtml += `</div></div>`; // Close rows and group

    $("#schedule-container").find(".timeline-wrapper").prepend(headerHtml);

    // --- 3. PROCESS ORDERS PER TEAM (OVERLAP LOGIC) ---
    teams.forEach(function(teamName) {
        // Filter orders for this team
        var teamOrders = orders.filter(function(o) {
            return o.team.indexOf(teamName) !== -1; // Handle "Team 1, Team 2"
        });

        // Sort by start time to handle overlaps sequentially
        teamOrders.sort(function(a, b) {
            return parseTime(a.time) - parseTime(b.time);
        });

        // LANE LOGIC: Assign vertical "Lanes" to avoid collision
        var lanes = []; // Array of end times for each lane. e.g. [600, 720]
        
        teamOrders.forEach(function(order) {
            var start = parseTime(order.time);
            var end = parseTime(order.duration);
            var placed = false;

            // Try to find a lane where this order fits
            for (var i = 0; i < lanes.length; i++) {
                if (lanes[i] <= start) {
                    order.lane = i;
                    lanes[i] = end; // Update lane end time
                    placed = true;
                    break;
                }
            }

            // If no lane found, create a new one
            if (!placed) {
                order.lane = lanes.length;
                lanes.push(end);
            }
        });

        // Determine Row Height based on number of lanes
        // Base height 80px per lane + padding
        var cardHeight = 70;
        var gap = 5;
        var rowHeight = Math.max(90, (lanes.length * (cardHeight + gap)) + 20);

        // --- RENDER ROW ---
        var safeTeamId = teamName.replace(/[^a-zA-Z0-9]/g, '');
        var rowHtml = `
            <div class="team-row" style="height: ${rowHeight}px;">
                <div class="team-name-col">
                    <div>${teamName}</div>
                    <small style="color:#666;">(${teamOrders.length} Jobs)</small>
                </div>
                <div class="timeline-track" id="track-${safeTeamId}">
                    </div>
            </div>`;
        
        var $row = $(rowHtml);
        var $track = $row.find(".timeline-track");

        // --- RENDER CARDS ---
        teamOrders.forEach(function(order) {
            var startMins = parseTime(order.time) - (startHour * 60);
            var durationMins = parseTime(order.duration) - parseTime(order.time);
            if(durationMins < 30) durationMins = 30; // Min width

            var leftPct = (startMins / totalMinutes) * 100;
            var widthPct = (durationMins / totalMinutes) * 100;
            var topPos = 10 + (order.lane * (cardHeight + gap)); // Vertical position

            // Style Selection
            var statusClass = "cc-status-other";
            var badgeText = "UNK";
            var st = order.status.toLowerCase();
            
            if(st.includes("scheduled")) { statusClass = "cc-status-scheduled"; badgeText = "SCHEDULED"; }
            else if(st.includes("paid") || st.includes("invoiced")) { statusClass = "cc-status-invoiced"; badgeText = "INVOICED"; }
            else if(st.includes("completed")) { statusClass = "cc-status-invoiced"; badgeText = "COMPLETED"; }
            else if(st.includes("day completed") || st.includes("active")) { statusClass = "cc-status-active"; badgeText = "ACTIVE"; }

            var cardHtml = `
                <div class="calendar-card ${statusClass}" 
                     style="left: ${leftPct}%; width: ${widthPct}%; top: ${topPos}px;">
                    
                    <div class="cc-header">
                        <span>${order.orderId}</span>
                        <span class="cc-badge">${badgeText}</span>
                    </div>
                    
                    <div class="cc-body">
                        <div class="cc-row">
                            <i class="fas fa-clock" style="font-size:9px; margin-right:3px;"></i> 
                            <b>${order.time} - ${order.duration}</b>
                        </div>
                        <div class="cc-row">
                            <i class="fas fa-tools" style="font-size:9px; margin-right:3px;"></i> 
                            <span title="${order.service}">${order.service}</span>
                        </div>
                    </div>

                    <div class="cc-btn editCurrentOrder" id="edit**${order.orderId}">
                        <i class="fas fa-eye"></i>
                    </div>
                </div>
            `;
            $track.append(cardHtml);
        });

        $("#schedule-rows").append($row);
    });
}

    // Helper: Convert "8:30 AM" string to minutes from midnight (00:00)
    function parseTime(timeStr) {
        if(!timeStr) return 0;
        
        // Remove quotes if present from backend string "'8:30 AM"
        timeStr = timeStr.replace(/'/g, ""); 

        var parts = timeStr.match(/(\d+):(\d+) (AM|PM)/);
        if (parts) {
            var hours = parseInt(parts[1]);
            var minutes = parseInt(parts[2]);
            var ampm = parts[3];

            if (ampm == "PM" && hours < 12) hours += 12;
            if (ampm == "AM" && hours == 12) hours = 0;

            return (hours * 60) + minutes;
        }
        return 0;
    }
   

    /**
     * Get the list of autocomplete
     */
    function getAutoCompleteList() {
    
        console.log("Running getAutoCompleteList");
        // We don't necessarily need the full cover spin for background updates, 
        // but if you prefer it: $('#cover-spin').show();

        google.script.run
            .withSuccessHandler(
                function(resultObject) {
                
                    console.log("Running getAutoCompleteList - success");
                    
                    // STORE DATA GLOBALLY
                    globalBackendData = resultObject;

                    // --- 1. Populate Dropdowns ---
                    
                    // General Services
                    var arrayGeneralService = resultObject[0];
                    var appendText = "";
                    for (var j in arrayGeneralService) {
                        appendText += '<option value="' + arrayGeneralService[j] + '">' + arrayGeneralService[j] + '</option>';
                    }
                    // Clear and append to avoid duplicates if run multiple times
                    var selects = $("#add-order-general-service,#edit-order-general-service,#calendar-select-service,#multiday-general-service");
                    // Note: Selectize handles clearing differently, but for standard selects:
                    // selects.empty().append(appendText); 
                    // Since you initialize Selectize once, we assume this runs mainly on load or strictly for data updates.

                    // Phone Autocomplete
                    $("#add-order-customer-call,#edit-order-customer-phone").autocomplete({
                        source: resultObject[1],
                        create: function( event, ui ) { $(this).attr('autocomplete', 'nope'); }
                    }).on("autocompleteselect", function(e, ui) {
                        getCustomerNameAndAddress(ui.item.value);
                    });
                    
                    $("#multiday-customer-phone").autocomplete({
                        source: resultObject[1],
                        create: function( event, ui ) { $(this).attr('autocomplete', 'nope'); }
                    }).on("autocompleteselect", function(e, ui) {
                        getMultidayCustomerNameAndAddress(ui.item.value);
                    });

                    // Teams
                    var arrayTeam = resultObject[2];
                    var appendTextTeam = "";
                    for (var i in arrayTeam) {
                        appendTextTeam += '<option value="' + arrayTeam[i] + '">' + arrayTeam[i] + '</option>';
                    }
                    // Check if empty before appending to prevent duplicates on refresh
                    if($("#add-order-team option").length <= 1) {
                         $("#add-order-team,#edit-order-team,#calendar-select-team,#multiday-team").append(appendTextTeam);
                         $("#team-leader-team,.team-selector-team").empty().append('<option>Select team</option>' + appendTextTeam);
                    }

                    // Past Bookings
                    $("#select-past-booking").autocomplete({
                        source: resultObject[6],
                        create: function( event, ui ) { $(this).attr('autocomplete', 'nope'); }
                    }).on("autocompleteselect", function(e, ui) {
                        getPastBookingDetails(ui.item.value);
                    });

                    // Rejection & Marketing
                    $("#rejected-order-reason").empty().append(resultObject[7]);
                    $(".where-know").empty().append(resultObject[9]);

                    // Invoice Autocomplete
                    $("#1-main").autocomplete({
                        source: resultObject[0],
                        minLength: 0,
                        create: function( event, ui ) { $(this).attr('autocomplete', 'nope'); }
                    }).on("autocompleteselect", function(e, ui) {
                        getSub1(ui.item.value, "1");
                    });

                    if ($('#table-normal-assignments tbody tr').length === 0) {
                        addAssignmentRow();
                    }
                    $("#container-add-order").css("visibility", "visible");
                    
                    // --- CRITICAL FIX: RENDER ALL TABLES ---
                    renderCoordinatorTables();      // Updates Current & Waitlist
                    renderPendingPaymentTables();   // Updates Pending Payment (Removes the row!)
                    renderCompletedTables();        // Updates Completed Orders
                    
                    $('#cover-spin').hide();
                })
            .withFailureHandler(
                function(msg) {
                    showError(msg, $('#button-add-order'));
                    $('#cover-spin').hide();
                })
            .withUserObject(this)
            .gasGetAutoCompleteList();
    }
    // --- NEW FUNCTIONS TO RENDER TABLES ONLY AFTER LOGIN ---

    function renderCoordinatorTables() {
        //Fill up current order table
        $("#table-current-order").find("tr:gt(0)").remove();
        $("#table-current-order").append(globalBackendData[3]);
        
        //Re-attach click listeners since we just added elements
        attachCoordinatorListeners(); 

        //Fill up waitlist order table
        $("#table-waitlist-order tr td").remove();
        $("#table-waitlist-order").append(globalBackendData[8]);
        
        //Re-attach waitlist listeners
        attachWaitlistListeners(); 
    }

    function renderCompletedTables() {
        $("#table-completed-order tr td").remove();
        $("#table-completed-order").append(globalBackendData[4]);
        
        //Re-attach listeners
        $(".editCompletedOrder").click(function() {
            $(".modal.completed").addClass('is-active');
            var id = $(this).attr("id");
            var splitOrderData = id.split("**");
            var orderId = splitOrderData[1];
            $("#modal-card-title-completed-order").text('Edit Order : ' + orderId);
        });
    }

    function renderPendingPaymentTables() {
        $("#table-pending-payment-order tr td").remove();
        $("#table-pending-payment-order").append(globalBackendData[5]);
        
        //Re-attach listeners for buttons inside the table
        attachPendingPaymentListeners();
    }

    // --- HELPER FUNCTIONS TO RE-ATTACH LISTENERS ---
    
  


    function attachWaitlistListeners() {
         $(".convertWaitlistButton").click(function() {
            var id = $(this).attr("id");
            var splitOrderData = id.split("**");
            var waitlistId = splitOrderData[1];
            $("#modal-card-title-current-order").text('Edit Waitlist Order Before Converting : ' + waitlistId);
            fillUpEditFormWithExistingData(waitlistId,"waitlist");
        });

        $(".cancelWaitlistButton").click(function() {
            var id = $(this).attr("id");
            var splitOrderData = id.split("**");
            var waitlistId = splitOrderData[1];
            $(this).parent().addClass('loading');
            $(this).remove();
            cancelWaitlistOrder(waitlistId);
        });
    }

    function attachPendingPaymentListeners() {
        $(".paidCashPendingPaymentOrder").click(function() {
            var id = $(this).attr("id");
            var splitOrderData = id.split("**");
            var orderId = splitOrderData[1];
            $(this).parent().addClass('loading');
            $(this).remove();
            markPaidCashOrder(orderId);
        });
        
        $(".paidPosPendingPaymentOrder").click(function() {
            var id = $(this).attr("id");
            var splitOrderData = id.split("**");
            var orderId = splitOrderData[1];
            $(this).parent().addClass('loading');
            $(this).remove();
            markPaidPosOrder(orderId);
        });

        $(".paidTransferPendingPaymentOrder").click(function() {
            var id = $(this).attr("id");
            var splitOrderData = id.split("**");
            var orderId = splitOrderData[1];
            $(this).parent().addClass('loading');
            $(this).remove();
            markPaidTransferOrder(orderId);
        });

        $(".paidChequePendingPaymentOrder").click(function() {
            var id = $(this).attr("id");
            var splitOrderData = id.split("**");
            var orderId = splitOrderData[1];
            $(this).parent().addClass('loading');
            $(this).remove();
            markPaidChequeOrder(orderId);
        });

        $(".paidLinkPendingPaymentOrder").click(function() {
            var id = $(this).attr("id");
            var splitOrderData = id.split("**");
            var orderId = splitOrderData[1];
            $(this).parent().addClass('loading');
            $(this).remove();
            markPaidLinkOrder(orderId);
        });
    }

    /**
     * Assign autocomplete to new row - main
     */
    function addAutoCompleteToNewRow(elementMain, rowNumber) {

        $("#" + rowNumber + "-main").addClass('loading');

        google.script.run
            .withSuccessHandler(
                function(resultObject) {

                    //Add auto complete to Main service in the invoice generator
                    elementMain.autocomplete({
                        source: resultObject[0],
                        minLength: 0,
                        create: function( event, ui ) {
                        $(this).attr('autocomplete', 'nope');
                        }
                    }).on("autocompleteselect", function(e, ui) {
                        getSub1(ui.item.value, rowNumber);
                    }).focus(function() {
                        $(this).autocomplete("search");
                    });

                    $("#" + rowNumber + "-main").removeClass('loading');

                    //Add calculation to qty field
                    $("#" + rowNumber + "-qty").change(function() {

                        //Once the qty get entered, calculate the subtotal
                        var main = $("#" + rowNumber + "-main").val();
                        var sub1 = $("#" + rowNumber + "-sub1").val();
                        var sub2 = $("#" + rowNumber + "-sub2").val();
                        var qty = $("#" + rowNumber + "-qty").val();

                        calculateServiceCost(main, sub1, sub2, qty, rowNumber);

                    });

                })
            .withFailureHandler(
                function(msg) {
                    showError(msg, $('#button-add-order'));

                })
            .withUserObject(this)
            .gasGetAutoCompleteList();

    }

    /**
     * Get customer name based on customer phone
     */
    function getCustomerNameAndAddress(customerPhoneNumber) {

        google.script.run

            .withSuccessHandler(
            function(result) {

                var customerName = result[0];
                var htmlAddressLabel = result[1];

                console.log("Select option for address:");
                console.log(htmlAddressLabel);

                //Auto populate name field
                $('#add-order-customer-name').val(customerName);

                //Auto populate Address select
                $("#add-order-address-select").empty();
                $("#add-order-address-select").append(htmlAddressLabel);

            })

        .withFailureHandler(
            function(msg) {

                showError(msg, $('#button-add-order'));

            })

        .withUserObject(this)

        .gasGetCustomerNameAndAddress(customerPhoneNumber);

    }

    /**
     * Get customer name/address for MULTI-DAY form
     */
    function getMultidayCustomerNameAndAddress(customerPhoneNumber) {
        google.script.run
            .withSuccessHandler(function(result) {
                var customerName = result[0];
                var htmlAddressLabel = result[1];

                // Auto populate Multi-day fields
                $('#multiday-customer-name').val(customerName);
                
                // Auto populate Address select
                $("#multiday-address-select").empty();
                $("#multiday-address-select").append(htmlAddressLabel);
            })
            .withFailureHandler(function(msg) {
                showError(msg, $('#button-submit-multiday'));
            })
            .gasGetCustomerNameAndAddress(customerPhoneNumber);
    }











    function getPastBookingDetails(pastOrderId) {

        google.script.run

            .withSuccessHandler(
            function(result) {

              console.log(result);

              var customerPhone = $('#add-order-customer-call').val(result['phone']);
              var customerName = $('#add-order-customer-name').val(result['name']);
              var note = $('#add-order-note').val(result['note']);
              $('#add-order-address-label').val(result['addressLabel']);
              $('#add-order-address-link').val(result['addressLink']);

              var selectize_generalService = $('#add-order-general-service').selectize();
              var selectize_generalService_sub = selectize_generalService[0].selectize;
              selectize_generalService_sub.clear();
              var items = result['service'];
              for (var i in items) {
                  selectize_generalService_sub.addItem(items[i]);
              }

              var selectize_team = $('#add-order-team').selectize();
              var selectize_team_sub = selectize_team[0].selectize;
              selectize_team_sub.clear();
              var items = result['team'];
              for (var i in items) {
                  selectize_team_sub.addItem(items[i]);
              }

              $('#form-normal-order').show();

            })

        .withFailureHandler(
            function(msg) {

                showError(msg, $('#button-add-order'));

            })

        .withUserObject(this)

        .gasGetPastBookingDetails(pastOrderId);

    }







    /**
     * Get calendar event and update calendar
     */
    function getCalendarEvent(selectedTeam, selectedService) {

        google.script.run

            .withSuccessHandler(
            function(events) {

              console.log("Updating team calendar");
              console.log(events);

                //Fullcalendar
                $("#calendar").fullCalendar('removeEvents');
                $('#calendar').fullCalendar('addEventSource', events);

            })

        .withFailureHandler(
            function(msg) {

            })

        .withUserObject(this)

        .gasGetCalendarEvents(selectedTeam, selectedService);

    }






    /**
     * Get Simple calendar event and update calendar
     */
    function getSimpleCalendarEvent() {

        google.script.run

            .withSuccessHandler(
            function(result) {

              var events = result[0];
              var htmlDateListForFilter = result[1];

              console.log("Updating simple team calendar");
              console.log(events);
              console.log(htmlDateListForFilter);

              //Prepare date filter
              $("#select-date-simple-calendar").empty();
              $("#select-date-simple-calendar").append(htmlDateListForFilter);

              //Add onChange to date filter
              $("#select-date-simple-calendar").change(function() {

                  var selectedDateFilter = $(this).val();

                  if(selectedDateFilter == "Please Select"){
                    $(".simple-event").hide();
                  }else{
                    $(".simple-event").hide();
                    $("."+selectedDateFilter+"").show();
                  }

              });

              //Remove existing events first
              console.log("Removing all simple events.")
              $('.simple-event').remove();

                var arrayMorning = events['morning'];
                var arrayAfternoon = events['afternoon'];
                var arrayEvening = events['evening'];
                var arrayNight = events['night'];

                console.log("Adding all simple events.")

                for(var i in arrayMorning){

                  var filterDate = arrayMorning[i]['filterDate'].replace(/ /g,'');

                  $( "#column-morning" ).append( "<div class='box simple-event editCurrentOrder "+filterDate+"' id='edit**"+arrayMorning[i]['orderNumber']+"'><b>"+arrayMorning[i]['dateTime']+"</b><br>"+arrayMorning[i]['teamService']+"<br><b style='color: #00d1b2;'>"+arrayMorning[i]['note']+"</b></div>" );

                }

                for(var i in arrayAfternoon){

                  var filterDate = arrayAfternoon[i]['filterDate'].replace(/ /g,'');

                  $( "#column-afternoon" ).append( "<div class='box simple-event editCurrentOrder "+filterDate+"' id='edit**"+arrayAfternoon[i]['orderNumber']+"'><b>"+arrayAfternoon[i]['dateTime']+"</b><br>"+arrayAfternoon[i]['teamService']+"<br><b style='color: #00d1b2;'>"+arrayAfternoon[i]['note']+"</b></div>" );

                }      

                for(var i in arrayEvening){

                  var filterDate = arrayEvening[i]['filterDate'].replace(/ /g,'');

                  $( "#column-evening" ).append( "<div class='box simple-event editCurrentOrder "+filterDate+"' id='edit**"+arrayEvening[i]['orderNumber']+"'><b>"+arrayEvening[i]['dateTime']+"</b><br>"+arrayEvening[i]['teamService']+"<br><b style='color: #00d1b2;'>"+arrayEvening[i]['note']+"</b></div>");

                }


                for(var i in arrayNight){

                  var filterDate = arrayNight[i]['filterDate'].replace(/ /g,'');

                  $( "#column-night" ).append( "<div class='box simple-event editCurrentOrder "+filterDate+"' id='edit**"+arrayNight[i]['orderNumber']+"'><b>"+arrayNight[i]['dateTime']+"</b><br>"+arrayNight[i]['teamService']+"<br><b style='color: #00d1b2;'>"+arrayNight[i]['note']+"</b></div>");

                }


                //Assign modal activation when event is clicked
                  


            //Hide all simple events when iniated or refreshed
            $(".simple-event").hide();                          

            })

        .withFailureHandler(
            function(msg) {

            })

        .withUserObject(this)

        .gasGetSimpleCalendarEvents();

    }







    function getTableTeamCurrentOrder(teamName) {
        google.script.run
            .withSuccessHandler(function(allResult) {
                var result = allResult[0];
                var htmlCard = allResult[1];
                $("#column-team-current-order").empty().append(htmlCard);
                $("#table-team-current-order tr td").remove();
                $("#table-team-current-order").append(result);

               // 4. "Generate Invoice" Button (Final Step -> Backend)
        // 4. "Generate Invoice" Button (Final Step -> Backend)
        $(".generateInvoice").unbind("click").click(function() {
    var btn = $(this);
    btn.addClass("is-loading"); 

    // Get basic info from the card
    var id = btn.attr("id");
    var splitOrderData = id.split("**");
    var orderId = splitOrderData[0];
    var customerName = splitOrderData[1];
    var customerPhone = splitOrderData[2];
    
    // Set Text Fields
    $("#text-order-num").text(orderId);
    $("#text-customer-name").text(customerName);
    $("#text-customer-phone").text(customerPhone);
    
    // Reset Invoice UI
    clearInvoice(true);
    $("#services-subtotal").text("0.00");
    $("#total-amount").text("0.00");
    $("#entry-grand-total").text("0.00");
    var currentLoggedInTeam = $('#team-selected-after-password').text().trim();

    // CALL BACKEND
    google.script.run
        .withSuccessHandler(function(result) {
            btn.removeClass("is-loading");
            
            // --- FIX: TEAM NAME DISPLAY ---
            var displayTeams = [];
            
            // 1. Add teams from Database (History)
            if (result.teams && result.teams.length > 0) {
                displayTeams = result.teams;
            }
            
            // 2. Add Current Logged In Team if missing (The "I am here now" logic)
            // We ignore if the user is "Coordinator" or default
            if (currentLoggedInTeam && currentLoggedInTeam !== "Current Orders" && currentLoggedInTeam !== "Select team") {
                // Check if already in list to avoid "Team 1 & Team 1"
                if (displayTeams.indexOf(currentLoggedInTeam) === -1) {
                    displayTeams.push(currentLoggedInTeam);
                }
            }

            // 3. Update UI
            if (displayTeams.length > 0) {
                $("#entry-team").text(displayTeams.join(" & "));
            } else {
                $("#entry-team").text("Current Team");
            }
            // -----------------------------

            // Open Modal FIRST
            isFinalInvoiceMode = true; 
            setupInvoiceModal();

            // Then Populate Services (Read-Only)
            if (result.services) {
                populateInvoiceTable(result.services);
            } else {
                populateInvoiceTable(result); 
            }
        })
        .withFailureHandler(function(err) {
            btn.removeClass("is-loading");
            alert("System Error: " + err);
        })
        .gasGetCompletedServices(orderId);
});
                // --- 2. COMPLETE DAY WORK LISTENER (YELLOW BUTTON) ---
                $(".completeDayWork").click(function() {
                    var id = $(this).attr("id");
                    var splitOrderData = id.split("**");
                    
                    var orderId = splitOrderData[1];
                    var orderDate = splitOrderData[2];
                    var team = splitOrderData[3]; 
                    var startT = splitOrderData[4];
                    var endT = splitOrderData[5];
                    
                    var card = $(this).closest('.card');
                    var displayName = "";
                    var displayPhone = "";
                    
                    if(card.length > 0) {
                         displayName = card.find("td").filter(function() { return $(this).text().trim() === "Name"; }).next().text().trim();
                         displayPhone = card.find("td").filter(function() { return $(this).text().trim() === "Phone Number"; }).next().text().trim();
                    } else {
                         var row = $(this).closest('tr');
                         displayPhone = row.find('td').eq(3).text(); 
                         displayName = row.find('td').eq(4).text(); 
                    }

                    $("#text-order-num").text(orderId);
                    $("#text-customer-name").text(displayName);
                    $("#text-customer-phone").text(displayPhone);
                    $("#entry-team").text(team); // Important for Status Update

                    $('#edit-order-team').val(team);
                    $('#edit-order-date').val(orderDate);
                    $('#edit-order-time').val(startT);
                    $('#edit-order-duration').val(endT);

                    isFinalInvoiceMode = false; // Set Mode to Daily Log
                    setupInvoiceModal();
                });

                $(".completedBackOrder").click(function() {
                    var id = $(this).attr("id");
                    var splitOrderData = id.split("**");
                    var orderId = splitOrderData[0];
                    $(this).closest('.card-team').remove();
                    $(this).closest('tr').remove();        
                    markCompletedBackOrder(orderId);
                });

            })
            .withFailureHandler(function(msg) {
                showError(msg, $("#team-leader-team"));
            })
            .withUserObject(this)
            .gasGetTableTeamCurrentOrder(teamName);
    }

    /**
     * Submit the form to backend and process the form
     */
    function addOrder(ignoreConflict) {
        // Clear previous messages
        $('#error').remove();
        $("#msg-normal-order").hide().text("");
        
        $('#button-add-order').addClass('is-loading').attr('disabled', true);

        // --- Gather Data ---
        var selectedOrderType = $('#select-order-type').val();
        var selectedAddress = $('#add-order-address-select').val();
        var addressLabel = $('#add-order-address-label').val();
        var addressLink = $('#add-order-address-link').val();
        var date = $('#add-order-date').val();
        var time = $('#add-order-time').val().toString();
        var duration = $('#add-order-end-time').val().toString();
        
        var teamsArr = [];
        var servicesArr = [];
        $('#table-normal-assignments tbody tr').each(function() {
            var t = $(this).find('.normal-row-team').val();
            var s = $(this).find('.normal-row-service').val();
            if(t && s) {
                teamsArr.push(t);
                servicesArr.push(s);
            }
        });
        var team = teamsArr.join(", ");
        var generalService = servicesArr.join(", ");
        
        var customerPhone = $('#add-order-customer-call').val().replace(/\s+/g, '');
        var customerPhone2 = $('#add-order-customer-call-2').val().replace(/\s+/g, '');
        var customerName = $('#add-order-customer-name').val();
        var note = $('#add-order-note').val();
        var whereKnow = $('#add-order-where-know').val();

        var allFormData = [date, "'"+time, "'"+duration, generalService, customerPhone, customerName, team, note, selectedOrderType, whereKnow, selectedAddress, addressLabel, addressLink, ignoreConflict, customerPhone2];

        // --- Validation ---
        if(date == "" || time == "" || duration == "" || generalService == "" || customerPhone == "" || customerName == "" || team == "") {
            $('#button-add-order').removeClass('is-loading').removeAttr('disabled');
            // Show error in the message box
            $("#msg-normal-order").removeClass('is-success').addClass('is-danger').html("Please fill up all fields<br>(Notes field is optional)").show();
            return;
        }

        if(customerPhone.length != 8){
            $('#button-add-order').removeClass('is-loading').removeAttr('disabled');
            $("#msg-normal-order").removeClass('is-success').addClass('is-danger').text("Please enter 8-digits phone number.").show();
            return;
        }

        var existingOrderId = '';
        if(selectedOrderType == "Back Order"){
            existingOrderId = $('#select-past-booking').val();
        }

        // --- Send to Backend ---
        google.script.run
            .withSuccessHandler(function(msg) {
                $('#button-add-order').removeClass('is-loading').removeAttr('disabled');

                if (msg.indexOf("clash") != -1 || msg.indexOf("Conflict") != -1) {
                    $('#error').remove();
                    $("#conflict-msg").html(msg);
                    $(".modal.conflict").addClass('is-active');
                    // 2. Setup the "Proceed Anyway" button
                    $('#button-add-order-ignore-conflict').off('click').on('click', function() {
                    $(".modal.conflict").removeClass('is-active');
                    addOrder(true); // Call recursively with ignoreConflict = true
                    });
                } else {
                    $(".modal.conflict").removeClass('is-active');
                    
                    // SUCCESS: Show Message in the box
                    $("#msg-normal-order")
                        .removeClass('is-danger')
                        .addClass('is-success')
                        .text(msg)
                        .fadeIn();

                    clearAddOrderForm();
                    getAutoCompleteList();
                    
                    // Hide message after 10 seconds
                    setTimeout(function(){ $("#msg-normal-order").fadeOut(); }, 10000);
                }
            })
            .withFailureHandler(function(msg) {
                $('#button-add-order').removeClass('is-loading').removeAttr('disabled');
                // Use the message box for errors too
                $("#msg-normal-order").removeClass('is-success').addClass('is-danger').text("Error: " + msg).show();
            })
            .gasAddOrder(allFormData, existingOrderId);
    }







    function addRejectedOrder() {

        $('#error').remove();
        showError('<progress class="progress is-small is-primary" max="100"></progress>', $('#button-rejected-order'));

        var customerPhone = $('#rejected-order-customer-phone').val().replace(/\s+/g, '');
        var reason = $('#rejected-order-reason').val();
        var note = $('#rejected-order-note').val();
        var whereKnow = $('#rejected-order-where-know').val();

        var allFormData = [customerPhone, reason, note, whereKnow];

        google.script.run

            .withSuccessHandler(
            function(msg) {
                
                $('#rejected-order-customer-phone').val('');
                $('#rejected-order-reason').val('');
                $('#rejected-order-note').val('');

                showError(msg, $('#button-rejected-order'));

            })

        .withFailureHandler(
            function(msg) {

                showError(msg, $('#button-rejected-order'));

            })

        .withUserObject(this)

        .gasAddRejectedOrder(allFormData);

    }







    /**
     * Update the order
     */
   function updateOrder() {
    var title = $('#modal-card-title-current-order').text();
    if (title.indexOf(" : ") === -1) return alert("Please wait for data to load.");
    
    var orderId = title.split(" : ")[1].trim();
    var isMultiDay = orderId.indexOf("/MD/") !== -1;
    var assignments = [];

    $('#edit-table-body tr').each(function() {
        var row = $(this);
        // If Multi-day, take date from the row. If Normal, take from the top 'edit-order-date' field.
        var rowDate = isMultiDay ? row.find('.edit-row-date').val() : $('#edit-order-date').val();

        if (row.find('.edit-row-team').val()) {
          assignments.push({
                team: row.find('.edit-row-team').val(),
                service: row.find('.edit-row-service').val(),
                date: rowDate,
                startT: row.find('.edit-row-start').val(),
                endT: row.find('.edit-row-end').val()
            });
        }
    });

    var payload = {
        orderId: orderId,
        name: $('#edit-order-customer-name').val(),
        phone: $('#edit-order-customer-phone').val(),
        phone2: $('#edit-order-customer-phone-2').val(),
        note: $('#edit-order-note').val(),
        status: $('#edit-order-status').val(),
        addressLabel: $('#edit-order-address-label').val(),
        addressLink: $('#edit-order-address-link').val(),
        assignments: assignments
    };

    $('#cover-spin').show();
    google.script.run
        .withSuccessHandler(function(msg) {
            $('#cover-spin').hide();
            $(".modal.current").removeClass('is-active');
            
            // --- REFRESH EVERYTHING ---
            getAutoCompleteList(); // Refreshes tables
            
            // REFRESH VISUAL SCHEDULE (Calendar View)
            var currentSchedDate = $("#schedule-date-picker").val();
            if (currentSchedDate) { loadDailySchedule(currentSchedDate); }
            
            alert(msg);
        })
        .withFailureHandler(function(err) {
            $('#cover-spin').hide();
            alert("System Error: " + err);
        })
        .gasUpdateOrderNew(payload);
}









    function convertWaitlistOrder() {

        console.log("Run convert : "+new(Date));

        $('#error').remove();
        showError('<progress class="progress is-small is-primary" max="100"></progress>', $('#table-waitlist-order'));

        var orderId = $('#modal-card-title-current-order').text().split(' : ')[1];
        orderId = parseInt(orderId);
        var date = $('#edit-order-date').val();
        var time = $('#edit-order-time').val().toString();
        var duration = $('#edit-order-duration').val();
        var generalService = $('#edit-order-general-service').val().toString();
        var customerPhone = $('#edit-order-customer-phone').val();
        var customerPhone2 = $('#edit-order-customer-phone-2').val();
        var customerName = $('#edit-order-customer-name').val();
        var team = $('#edit-order-team').val().toString();
        var note = $('#edit-order-note').val();
        var status = "Scheduled";
        var selectedAddress = $('#edit-order-address-select').val();
        var addressLabel = $('#edit-order-address-label').val();
        var addressLink = $('#edit-order-address-link').val();

        var allFormData = [orderId, date, "'"+time, "'"+duration, customerPhone, customerName, team, generalService, note, status, selectedAddress,addressLabel, addressLink,customerPhone2];
        
        
        //Mandatory field checking
        
        if(date == "" || time == "" || duration == "" || generalService == "" || customerPhone == "" || customerName == "" || team == "") {
        
        $('#error').remove();
        showError("Please fill up all fields<br>(Notes field is optional)", $('#table-waitlist-order'));
        return;
        
        }

        google.script.run

            .withSuccessHandler(
            function(msg) {

                getAutoCompleteList();

                showError(msg, $('#table-waitlist-order'));

            })

        .withFailureHandler(
            function(msg) {

                showError(msg, $('#table-waitlist-order'));

            })

        .withUserObject(this)

        .gasConvertWaitlistOrder(allFormData);

    }










    function cancelWaitlistOrder(waitlistId) {

        $('#error').remove();

        google.script.run

            .withSuccessHandler(
            function(result) {

              getAutoCompleteList();

            })

        .gasCancelWaitlistOrder(waitlistId);

    }





    
    
    
    
    
     /**
     * Update the order
     */
    function updateCompletedOrderStatus() {

        $('#error').remove();
        showError('<progress class="progress is-small is-primary" max="100"></progress>', $('#table-completed-order'));

        var orderId = $("#modal-card-title-completed-order").text().split(' : ')[1];
        orderId = parseInt(orderId);
        var status = $('#edit-completed-order-status').val();

        var allFormData = [orderId, status];
        
        console.log(allFormData);
        
        
        google.script.run

            .withSuccessHandler(
            function(msg) {

                getAutoCompleteList();

                showError(msg, $('#table-completed-order'));

            })

        .withFailureHandler(
            function(msg) {

                showError(msg, $('#table-completed-order'));

            })

        .withUserObject(this)

        .gasUpdateCompletedOrderStatus(allFormData);

    }
    
    
    
    

    /**
     * Fill up the edit form (modal) with existing data
     */
   function fillUpEditFormWithExistingData(orderId, type, specificDate) {
    $('#error').remove();
    var stopSpinner = function() { $('.editCurrentOrder').removeClass('is-loading'); };

    google.script.run
        .withSuccessHandler(function(returned) {
            stopSpinner();
            if (!returned || !returned.details) {
                alert("Error: Order not found.");
                return;
            }
            
            var result = returned.details; 
            var tasks = returned.tasks;
            var isMultiDay = orderId.toString().indexOf("/MD/") !== -1;

            $('#modal-card-title-current-order').text('Edit Order : ' + orderId);
            $('#edit-order-customer-name').val(result[6]);
            $('#edit-order-customer-phone').val(result[5]);
            $('#edit-order-customer-phone-2').val(result[12] || "");
            $('#edit-order-note').val(result[8]);
            $('#edit-order-status').val(result[9]);
            $('#edit-order-address-label').val(result[10]);
            $('#edit-order-address-link').val(result[11]);
            $("#edit-order-address-select").empty().append(result[13]);

            var header = $('#edit-table-header').empty();
            $('#edit-table-body').empty();

            // FIX: Ensure Start/End columns appear for Normal orders too
            if (isMultiDay) {
                header.append('<th>Date</th><th style="width:120px;">Start</th><th style="width:120px;">End</th><th>Team</th><th>Service</th><th style="width:50px;"></th>');
                $('#edit-order-date').closest('.column').hide(); 
            } else {
                header.append('<th style="width:120px;">Start</th><th style="width:120px;">End</th><th>Team</th><th>Service</th><th style="width:50px;"></th>');
                $('#edit-order-date').closest('.column').show();
                $('#edit-order-date').val(result[1]);
            }

            tasks.forEach(function(task) {
            var startTime = task.startT;
    
    // --- FIX START: Better handling of 1899 dates ---
    // If the backend sends a raw string like "Sat Dec 30 1899...", clean it here
    if (startTime && startTime.includes("1899")) {
        var dateObj = new Date(startTime);
        if (!isNaN(dateObj.getTime())) {
            // Convert to 12h format manually to match dropdowns
            var hours = dateObj.getHours();
            var minutes = dateObj.getMinutes();
            var ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = minutes < 10 ? '0'+minutes : minutes;
            startTime = hours + ':' + minutes + ' ' + ampm;
            
            // Update the task object so addEditRow uses the clean time
            task.startT = startTime; 
        }
    }
                addEditRow(isMultiDay, task);
            });

            $(".modal.current").addClass('is-active');
            if(type === "waitlist") {
                $("#button-convert-modal").show();
                $("#button-save-modal").hide();
            } else {
                $("#button-convert-modal").hide();
                $("#button-save-modal").show();
            }
        })
        .withFailureHandler(function(err) {
            stopSpinner();
            alert("Execution Error: " + err);
        })
        .gasGetOrderDetailWithOrderId(orderId, type, specificDate);
}

function addEditRow(isMultiDay, taskData) {
    if (!globalBackendData || globalBackendData.length === 0) return;

    var teamOptions = "";
    globalBackendData[2].forEach(function(t) { teamOptions += `<option value="${t}">${t}</option>`; });
    var serviceOptions = "";
    globalBackendData[0].forEach(function(s) { serviceOptions += `<option value="${s}">${s}</option>`; });
    
    // Get standard time options (e.g. 8:00, 8:30)
    var timeOptions = $('#add-order-time').html();

    var rowHtml = "<tr>";
    if (isMultiDay) {
        rowHtml += `<td><input class="input is-small edit-row-date" type="text" value="${taskData.date || ''}" readonly></td>`;
    }
    
    // Create the selects with the standard options first
    rowHtml += `<td><div class="select is-small is-fullwidth"><select class="edit-row-start">${timeOptions}</select></div></td>`;
    rowHtml += `<td><div class="select is-small is-fullwidth"><select class="edit-row-end">${timeOptions}</select></div></td>`;
    
    rowHtml += `<td><div class="select is-small is-fullwidth"><select class="edit-row-team">${teamOptions}</select></div></td>`;
    rowHtml += `<td><div class="select is-small is-fullwidth"><select class="edit-row-service">${serviceOptions}</select></div></td>`;
    rowHtml += `<td class="has-text-centered"><a class="has-text-danger" onclick="$(this).closest('tr').remove()"><i class="fas fa-trash-alt"></i></a></td></tr>`;

    var $row = $(rowHtml);
    $('#edit-table-body').append($row);

    // Populate values
    if (taskData) {
        $row.find('.edit-row-team').val(taskData.team);
        $row.find('.edit-row-service').val(taskData.service);

        // --- FIX START: HANDLE CUSTOM TIMES (e.g., 8:02 AM) ---
        var startSelect = $row.find('.edit-row-start');
        var endSelect = $row.find('.edit-row-end');

        // Check if the Start Time from DB exists in the dropdown
        if (taskData.startT && startSelect.find("option[value='" + taskData.startT + "']").length === 0) {
            // It doesn't exist (e.g. 8:02 AM), so ADD it to the top of the list
            startSelect.prepend('<option value="' + taskData.startT + '">' + taskData.startT + '</option>');
        }
        // Now we can safely set the value
        startSelect.val(taskData.startT);

        // Check if the End Time from DB exists in the dropdown
        if (taskData.endT && endSelect.find("option[value='" + taskData.endT + "']").length === 0) {
            // It doesn't exist, ADD it
            endSelect.prepend('<option value="' + taskData.endT + '">' + taskData.endT + '</option>');
        }
        // Set the value
        endSelect.val(taskData.endT);
        // --- FIX END ---
    }

    if (isMultiDay) {
        $row.find('.edit-row-date').datepicker({
            dateFormat: 'mm/dd/yy',
            appendTo: ".modal-card-body", 
            beforeShow: function (input, inst) {
                setTimeout(function () { inst.dpDiv.css({ 'z-index': 11000 }); }, 0);
            }
        });
    }
}











    function getAddressLink(phoneNumber, addressLabel, type) {
        $('#error').remove();

        google.script.run
            .withSuccessHandler(function(result) {
                var link = result[0];
                var returnType = result[1];

                if (returnType == 'addOrder') {
                    $('#add-order-address-link').val(link);
                } else if (returnType == 'editOrder') {
                    $('#edit-order-address-link').val(link);
                } else if (returnType == 'multiday') { 
                    $('#multiday-address-link').val(link);
                    $('#multiday-address-link').removeClass("is-loading"); // Remove loading style
                }
            })
            .withFailureHandler(function(msg) {
                console.log("Error fetching link: " + msg);
            })
            .withUserObject(this)
            .gasGetAddressLink(phoneNumber, addressLabel, type);
    }












    /**
     * Fill up the edit form (modal) with existing data
     */
    function markReviewedOrder(orderId) {

        $('#error').remove();

        google.script.run

            .withSuccessHandler(
            function(result) {

            })

        .withFailureHandler(
            function(msg) {

            })

        .withUserObject(this)

        .gasMarkReviewedOrder(orderId);

    }





    function markCompletedBackOrder(orderId) {

        $('#error').remove();

        google.script.run

            .withSuccessHandler(
            function(result) {

            })

        .withFailureHandler(
            function(msg) {

            })

        .withUserObject(this)

        .gasMarkCompletedBackOrder(orderId);

    }




    function markPaidCashOrder(orderId) {

        $('#error').remove();

        google.script.run

            .withSuccessHandler(
            function(result) {

              getAutoCompleteList();

            })

        .gasMarkPaidCashOrder(orderId);

    }



    function markPaidPosOrder(orderId) {

        $('#error').remove();

        google.script.run

            .withSuccessHandler(
            function(result) {

              getAutoCompleteList();

            })

        .gasMarkPaidPosOrder(orderId);

    }





    function markPaidTransferOrder(orderId) {

        $('#error').remove();

        google.script.run

            .withSuccessHandler(
            function(result) {

              getAutoCompleteList();

            })

        .gasMarkPaidTransferOrder(orderId);

    }





    function markPaidChequeOrder(orderId) {

        $('#error').remove();

        google.script.run

            .withSuccessHandler(
            function(result) {

              getAutoCompleteList();

            })

        .gasMarkPaidChequeOrder(orderId);

    }



    function markPaidLinkOrder(orderId) {

        $('#error').remove();

        google.script.run

            .withSuccessHandler(
            function(result) {

              getAutoCompleteList();

            })

        .gasMarkPaidLinkOrder(orderId);

    }







    /**
     * Get sub 1
     */
    function getSub1(mainSub, rowNumber) {

        $("#" + rowNumber + "-sub1").addClass('loading');

        google.script.run
            .withSuccessHandler(
                function(sub1) {

                    //Add auto complete to first Main service in the invoice generator
                    $("#" + rowNumber + "-sub1").autocomplete({
                        source: sub1,
                        minLength: 0,
                    }).focus(function() {
                        $(this).autocomplete("search");
                    }).on("autocompleteselect", function(e, ui) {
                        getSub2(ui.item.value, rowNumber);
                    });

                    $("#" + rowNumber + "-sub1").removeClass('loading');

                })
            .withFailureHandler(

                function(msg) {
                    showError(msg, $('#button-add-row'));

                })
            .withUserObject(this)
            .gasGetSub1(mainSub);

    }



    /**
     * Update the calendars
     */
    function updateCalendars() {

      getCalendarEvent('','');
      //getSimpleCalendarEvent();

    }






    /**
     * Get sub 2
     */
    function getSub2(sub1, rowNumber) {

        $("#" + rowNumber + "-sub2").addClass('loading');

        var main = $("#" + rowNumber + "-main").val();

        google.script.run
            .withSuccessHandler(
                function(sub2) {

                    //Add auto complete to first Main service in the invoice generator
                    $("#" + rowNumber + "-sub2").autocomplete({
                        source: sub2,
                        minLength: 0,
                    }).focus(function() {
                        $(this).autocomplete("search");
                    }).on("autocompleteselect", function(e, ui) {
                        console.log("WALA:"+ui.item.value+":"+rowNumber);
                        getUnit(ui.item.value, rowNumber);
                    });

                    $("#" + rowNumber + "-sub2").removeClass('loading');

                })
            .withFailureHandler(

                function(msg) {
                    showError(msg, $('#button-add-row'));

                })
            .withUserObject(this)
            .gasGetSub2(main, sub1);

    }
    
    
    
    
     /**
     * Get unit after sub 2 is selected
     */
    function getUnit(sub2, rowNumber) {

        var main = $("#" + rowNumber + "-main").val();
        var sub1 = $("#" + rowNumber + "-sub1").val(); 
        
        console.log("main:"+main+":"+sub1+":"+sub2);

        google.script.run
            .withSuccessHandler(
                function(unit) {
                    
                    console.log("UNIT:"+unit);

                    //Add unit to the span
                    $("#" + rowNumber + "-unit").text(" " + unit).show();

                })
            .withFailureHandler(

                function(msg) {
                    showError(msg, $('#button-add-row'));

                })
            .withUserObject(this)
            .gasGetUnit(main, sub1, sub2);

    }
    
    
    

    /**
     * Calculate service cost
     */
    function calculateServiceCost(main, sub1, sub2, qty, rowNumber) {

        $("#" + rowNumber + "-total").addClass('loading');

        google.script.run
            .withSuccessHandler(
                function(total) {

                    $("#" + rowNumber + "-total").empty();
                    $("#" + rowNumber + "-total").append(total);

                    $("#" + rowNumber + "-total").removeClass('loading');

                    calculateTotalCost();

                })
            .withFailureHandler(

                function(msg) {
                    showError(msg, $('#button-add-row'));

                })
            .withUserObject(this)
            .gasCalculateServiceCost(main, sub1, sub2, qty);

    }

    /**
     * Calculate total cost and update summary
     */
    function calculateTotalCost() {
        var subtotalService = 0;
        $('td[name=total]').each(function() {
            if($(this).text() != ""){
                subtotalService = subtotalService + parseFloat($(this).text());
            }
        });

        var subtotalSparePart = parseFloat($('#spare-part-cost').val()) || 0;
        var subtotalLocation = parseFloat($('#location-charge').val()) || 0;
        var subtotalDiscount = parseFloat($('#discount').val()) || 0;

        var totalAmount = (subtotalService + subtotalSparePart + subtotalLocation - subtotalDiscount);

        // Update Hidden Fields (for tracking)
        $('#services-subtotal').text(subtotalService.toFixed(2));
        $('#spare-subtotal').text(subtotalSparePart.toFixed(2));
        $('#location-subtotal').text(subtotalLocation.toFixed(2));
        $('#discount-subtotal').text(subtotalDiscount.toFixed(2));
        $('#total-amount').text(totalAmount.toFixed(2));
        
        // --- NEW: Update the Visible Summary on Final Page ---
        $('#final-services-subtotal').text(subtotalService.toFixed(2));
        $('#final-spare-subtotal').text(subtotalSparePart.toFixed(2));
        $('#final-location-subtotal').text(subtotalLocation.toFixed(2));
        $('#final-discount-subtotal').text(subtotalDiscount.toFixed(2));
        $('#final-total-amount').text(totalAmount.toFixed(2));
        
        // Also update the Grand Total on the first page
        $('#entry-grand-total').text(totalAmount.toFixed(2));  
    }

   
    // --- NEW: Helper to add rows for Normal Order (Team+Service) ---
    function addAssignmentRow() {
        var rowId = Date.now();
        
        // Build Options from Global Data
        var teamOptions = "";
        var serviceOptions = "";
        
        if (typeof globalBackendData !== 'undefined') {
             // Teams are index 2
             if(globalBackendData[2]) {
                 globalBackendData[2].forEach(function(t) { teamOptions += `<option value="${t}">${t}</option>`; });
             }
             // Services are index 0
             if(globalBackendData[0]) {
                 globalBackendData[0].forEach(function(s) { serviceOptions += `<option value="${s}">${s}</option>`; });
             }
        }

        var rowHtml = `
            <tr id="assign-${rowId}">
                <td>
                    <div class="select is-fullwidth">
                        <select class="normal-row-team">${teamOptions}</select>
                    </div>
                </td>
                <td>
                    <div class="select is-fullwidth">
                        <select class="normal-row-service">${serviceOptions}</select>
                    </div>
                </td>
                <td>
                    <a class="button is-danger is-small is-outlined" onclick="$(this).closest('tr').remove()">
                        <i class="fas fa-trash"></i>
                    </a>
                </td>
            </tr>
        `;
        $('#table-normal-assignments tbody').append(rowHtml);
        
        // Initialize Selectize for better UX
        $(`#assign-${rowId} .normal-row-team`).selectize();
        $(`#assign-${rowId} .normal-row-service`).selectize();
    } 
    // --- MULTI-DAY ORDER FUNCTIONS ---

    function addMultidayRow() {
        var rowId = Date.now(); 
        var timeOptions = $('#add-order-time').html(); 
        var durationOptions = $('#add-order-end-time').html(); 
        
        // --- FIX START: Build options from Global Data instead of DOM ---
        var teamOptions = "";
        
        // globalBackendData[2] contains the list of Teams
        if (typeof globalBackendData !== 'undefined' && globalBackendData[2]) {
             var teams = globalBackendData[2];
             for(var i=0; i<teams.length; i++) {
                 teamOptions += '<option value="' + teams[i] + '">' + teams[i] + '</option>';
             }
        } else {
             teamOptions = '<option value="">Loading...</option>';
        }
        var serviceOptions = "";
        if (typeof globalBackendData !== 'undefined' && globalBackendData[0]) {
             var services = globalBackendData[0];
             for(var j=0; j<services.length; j++) {
                 serviceOptions += '<option value="' + services[j] + '">' + services[j] + '</option>';
             }
        }
        // --- FIX END ---

        var rowHtml = `
            <tr id="row-${rowId}">
                <td><input class="input multiday-date" type="text" readonly placeholder="Select Date"></td>
                <td>
                    <div class="select is-fullwidth"><select class="multiday-time">${timeOptions}</select></div>
                </td>
                <td>
                    <div class="select is-fullwidth"><select class="multiday-duration">${durationOptions}</select></div>
                </td>
                <td>
                    <div class="select is-fullwidth"><select class="multiday-row-team">${teamOptions}</select></div>
                </td>
                <td>
                    <div class="select is-fullwidth"><select class="multiday-row-service">${serviceOptions}</select></div>
                </td>
                <td>
                    <a class="button is-danger is-small is-outlined delete-multiday-row" onclick="$(this).closest('tr').remove()">
                        <i class="fas fa-trash"></i>
                    </a>
                </td>
            </tr>
        `;
        $('#table-multiday-dates tbody').append(rowHtml);
        
        // Init Selectize for the new row
        $('#row-' + rowId + ' .multiday-row-team').selectize();
        $('#row-' + rowId + ' .multiday-row-service').selectize();
        $('#row-' + rowId + ' .multiday-date').datepicker();
    }

    // Button Click Listener
    $('#button-add-multiday-row').click(function() {
        addMultidayRow();
    });
    
    // Submit Button Listener
    $('#button-submit-multiday').click(function() {
        submitMultidayOrder(false); // False = Don't ignore conflict initially
    });

    // Main Submission Function
    function submitMultidayOrder(ignoreConflict) {
    $('#error').remove();
    // Show loading spinner
    showError('<progress class="progress is-small is-primary" max="100"></progress>', $('#button-submit-multiday'));

    // Initialize arrays
    var dates = [];
    var times = [];
    var durations = [];
    var teams = [];
    var services = [];

    var validationError = "";

    // --- FIX: LOOP THROUGH TABLE ROWS SAFELY ---
    $('#table-multiday-dates tbody tr').each(function(index) {
        var row = $(this); // The current row
        var rowNum = index + 1;

        // 1. Get values specifically from THIS row
        var dateVal = row.find('.multiday-date').val();
        var timeVal = row.find('.multiday-time').val();
        var durVal = row.find('.multiday-duration').val();
        var teamVal = row.find('.multiday-row-team').val(); // Selectize updates the original select
        var servVal = row.find('.multiday-row-service').val();

        // 2. Validate THIS row immediately
        if (!dateVal) {
            validationError = "Error: Date is missing in Row " + rowNum;
            return false; // Break the loop
        }
        if (!teamVal || teamVal === "Select team" || teamVal === "") {
            validationError = "Error: Team is not selected in Row " + rowNum;
            return false; // Break the loop
        }
        if (!servVal) {
            validationError = "Error: Service is not selected in Row " + rowNum;
            return false; // Break the loop
        }

        // 3. Push to arrays if valid
        dates.push(dateVal);
        times.push("'" + timeVal);
        durations.push("'" + durVal);
        teams.push(teamVal);
        services.push(servVal);
    });

    // If validation failed inside the loop, stop here
    if (validationError !== "") {
        alert(validationError);
        $('#button-submit-multiday').removeClass('is-loading');
        $('#error').remove(); // Remove spinner
        return;
    }

    // --- END FIX ---

    // 2. Gather Standard Fields
    var customerPhone = $('#multiday-customer-phone').val().replace(/\s+/g, '');
    var customerPhone2 = $('#multiday-customer-phone-2').val().replace(/\s+/g, '');
    var customerName = $('#multiday-customer-name').val();
    var note = $('#multiday-note').val();
    var whereKnow = $('#multiday-where-know').val();
    var selectedAddress = $('#multiday-address-select').val();
    var addressLabel = $('#multiday-address-label').val();
    var addressLink = $('#multiday-address-link').val();

    // Standard Validation
    if (customerPhone == "") {
        alert("Error: Customer Phone is empty.");
        $('#button-submit-multiday').removeClass('is-loading');
        $('#error').remove();
        return;
    }
    if (customerName == "") {
        alert("Error: Customer Name is empty.");
        $('#button-submit-multiday').removeClass('is-loading');
        $('#error').remove();
        return;
    }

    // 3. Pack Data
    var allFormData = [
        JSON.stringify(dates),
        JSON.stringify(times),
        JSON.stringify(durations),
        JSON.stringify(services),
        customerPhone,
        customerName,
        JSON.stringify(teams),
        note,
        'Multi-day Order',
        whereKnow,
        selectedAddress,
        addressLabel,
        addressLink,
        ignoreConflict,
        customerPhone2
    ];

    // 4. Send to Backend
    google.script.run
        .withSuccessHandler(function(msg) {
            $('#button-submit-multiday').removeClass('is-loading');
            if (msg.indexOf("Conflict") != -1) {
                $('#error').remove();
                $("#conflict-msg").html(msg);
                $('#button-add-order-ignore-conflict').off('click').on('click', function() {
                    $(".modal.conflict").removeClass('is-active');
                    submitMultidayOrder(true);
                });
                $(".modal.conflict").addClass('is-active');
            } else {
                $(".modal.conflict").removeClass('is-active');
                $("#msg-multiday-order")
                        .removeClass('is-danger')
                        .addClass('is-success')
                        .text(msg)
                        .fadeIn();
                
                // Clear Form
                $('#table-multiday-dates tbody').empty();
                addMultidayRow();
                $('#multiday-customer-phone').val('');
                $('#multiday-customer-name').val('');
                $('#multiday-note').val('');
                $('#multiday-address-label').val('');
                $('#multiday-address-link').val('');
                $('#error').remove();
                // --- NEW: INSTANT REFRESH ---
            getAutoCompleteList(); // Reloads the "Current Orders" table
            
            var currentDate = $("#schedule-date-picker").val();
            if(currentDate) {
                loadDailySchedule(currentDate); // Reloads the "Calendar" view
            }
            // ----------------------------
            }
        })
        .withFailureHandler(function(msg) {
            $('#button-submit-multiday').removeClass('is-loading');
            showError(msg, $('#button-submit-multiday'));
        })
        .gasAddOrder(allFormData, "");
}

    // 3. Initialize AutoComplete for Multi-day fields (In getAutoCompleteList success handler)
    // Find: $("#add-order-general-service,#edit-order-general-service,#calendar-select-service").append(appendText);
    // Change to include #multiday-general-service
    
    // Find: $("#add-order-team,#edit-order-team,#calendar-select-team").append(appendText);
    // Change to include #multiday-team
    
    // Find: $("#add-order-customer-call,#edit-order-customer-phone").autocomplete...
    // Change to include #multiday-customer-phone
    
    
    
    
    
    
    
     /**
     * Clear add order form
     */
    function clearAddOrderForm() {
    // 1. Clear simple text and date fields
    $('#add-order-date, #add-order-customer-call, #add-order-customer-call-2, #add-order-customer-name, #add-order-note, #add-order-address-label, #add-order-address-link').val('');
    
    // 2. Clear the dynamic assignment tables
    $('#table-normal-assignments tbody').empty();
    $('#table-multiday-dates tbody').empty();
    
    // 3. Reset the Address dropdown to default
    $('#add-order-address-select').empty().append('<option value="Please Select">Please select</option><option value="newaddress">Add new address</option>');
    
    // 4. Reset the Order Type selector
    $('#select-order-type').val('Please Select');
    $('.form-order').hide();

    // 5. Add back one fresh row so the form isn't empty
    addAssignmentRow();
}
    
    
    
    
    

    /**
     * Inserts a div that contains an error message after a given element.
     *
     * @param {string} msg The error message to display.
     * @param {DOMElement} element The element after which to display the error.
     */

    function showError(msg, element) {

        $('#error').remove();
        var div = $('<div id="error" class="error"><br>' + msg + '</div>');
        $(element).after(div);
    }

    /*
     * Script for signature pad
     */

    
    

    
    
   
  
    //$('.invoice-box').hide();

 function submitInvoice() {
    $('#error').remove();
    var btn = $('#btn-real-submit-invoice'); 
    showError('<progress class="progress is-small is-primary" max="100"></progress>', btn);

    // Get all data from form
    var orderNumber = $('#text-order-num').text();
    var customerName = $('#text-customer-name').text();
    var customerPhone = $('#text-customer-phone').text();
    // --- NEW: GET TEAM NAME ---
    var teamName = $('#entry-team').text(); // Grabs "Team 1 & Team 2" or whatever is in header

    var subtotalServices = parseFloat($('#services-subtotal').text()).toFixed(2);
    var subtotalSparePart = parseFloat($('#spare-subtotal').text()).toFixed(2);
    var subtotalLocation = parseFloat($('#location-subtotal').text()).toFixed(2);
    var subtotalDiscount = parseFloat($('#discount-subtotal').text()).toFixed(2);
    var totalAmount = parseFloat($('#total-amount').text()).toFixed(2);
    
    var building = $('#building').val();
    var street = $('#street').val();
    var zone = $('#zone').val();
    var signature = ""; 
    var paymentStatus = $("input[name='payment-status']:checked").val();

    // Mandatory field checking
    var errorMandatoryField = "";
    if (typeof paymentStatus == "undefined") errorMandatoryField += 'Please select payment status.<br>';
    if (building == "" || street == "" || zone == "") errorMandatoryField += 'Please complete address.<br>';
    if ($('#spare-part-cost').val() == "") errorMandatoryField += 'Enter spare part cost.<br>';
    if (subtotalSparePart != 0 && $('#button-add-photo').val() == '') errorMandatoryField += 'Upload receipt.<br>';
    if ($('#discount').val() == "") errorMandatoryField += 'Enter discount.<br>';

    if (errorMandatoryField != "") {
        $('#error').remove();
        showError(errorMandatoryField, btn);
        btn.removeClass('is-loading');
        btn.removeAttr('disabled');
        return;
    }

    btn.attr('disabled', true);
    btn.addClass("disabled-link");
    
    var arrayServices = [];
    $('#table-invoice-item tr').each(function(i) {
        if (i > 0) { 
            var main = $(this).find("input[name='main']").val();
            var sub1 = $(this).find("input[name='sub1']").val();
            var sub2 = $(this).find("input[name='sub2']").val();
            var qty  = $(this).find("input[name='qty']").val();
            var totalText = $(this).find("td[name='total']").text(); 
            var total = parseFloat(totalText.replace(/,/g, '')) || 0;

            if (main && main !== "") {
                arrayServices.push([main, sub1, sub2, qty, total.toFixed(2)]);
            }
        }
    });

    var file, reader = new FileReader();
    var fileInput = $('#button-add-photo')[0];
    var fileExist = false;
    if (fileInput.files.length > 0) { file = fileInput.files[0]; fileExist = true; }

    var onSuccess = function(result) {
        $('#error').remove();
        btn.removeClass('is-loading'); 
        showError('Invoice created!', btn);

        var text = "%0A" + "    " +
            "%0A" + "     " +
            "%0A" + "          " +
            "%0A" + "%0A" +
            "Thank you for using RSH services" + "%0A" +
            "We hope that you are satisfied with our service" + "%0A" +
            "You can find the receipt in the link below" + "%0A" + "%0A" +
            result[0] + "%0A" +
            "%0A" + "           " + "%0A" +
            "Please evaluate our services and share your experience and feedback with us through the link below" + "%0A" + "%0A" +
            "https://g.page/r/CdGnKEQ6bDDeEBM/review";

        var textWhatsApp = "https://wa.me/974" + result[1] + "?text=" + text;

        $('#button-view-invoice').remove();
        $('#button-send-whatsapp').remove();
        
        $('#error').after('<br><br><a class="button is-success" id="button-view-invoice" href="' + result[0] + '" target="_blank">View Invoice</a> <a class="button is-success" id="button-send-whatsapp" href="' + textWhatsApp + '" target="_blank">Send via Whatsapp</a>');
        getAutoCompleteList();
        var teamAfterPassword = $('#team-selected-after-password').text();
        getTableTeamCurrentOrder(teamAfterPassword);
        clearInvoice(false);
        btn.removeAttr('disabled').removeClass("disabled-link");
    };

    if (!fileExist) {
        google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(function(msg) { showError(msg, btn); btn.removeClass('is-loading'); btn.removeAttr('disabled').removeClass("disabled-link"); })
            .withUserObject(this)
            // --- FIX: Pass 'teamName' to backend ---
            .processSubmittedInvoice(orderNumber, customerName, customerPhone, arrayServices, building, street, zone, "", fileExist, signature, paymentStatus, teamName, subtotalSparePart, subtotalLocation, subtotalDiscount, totalAmount);
    } else {
        reader.readAsDataURL(file);
        reader.onloadend = function(e) {
            google.script.run
                .withSuccessHandler(onSuccess)
                .withFailureHandler(function(msg) { showError(msg, btn); btn.removeClass('is-loading'); btn.removeAttr('disabled').removeClass("disabled-link"); })
                .withUserObject(this)
                // --- FIX: Pass 'teamName' to backend ---
                .processSubmittedInvoice(orderNumber, customerName, customerPhone, arrayServices, building, street, zone, e.target.result, fileExist, signature, paymentStatus, teamName, subtotalSparePart, subtotalLocation, subtotalDiscount, totalAmount);
        };
    }
}
  

    function submitDailyWork() {
    // 1. Gather Data
    var orderId = $.trim($('#text-order-num').text()); 
    var date = $('#edit-order-date').val(); 
    var team = $('#team-selected-after-password').text().trim();
    if (!team || team === "" || team === "Current Orders") {
        team = $('#entry-team').text().trim();
    }
    var startTime = $('#edit-order-time').val();
    var endTime = $('#edit-order-duration').val();

    var serviceList = [];
    $('#table-invoice-item tr').each(function(i) {
        if (i > 0) { 
           var main = $(this).find("input[name='main']").val();
           var sub = $(this).find("input[name='sub1']").val();
           var sub2 = $(this).find("input[name='sub2']").val();
           var qty = $(this).find("input[name='qty']").val();
           var unit = $(this).find(".unit-text, span[id$='-unit']").text().trim();
           var totalText = $(this).find("td[name='total']").text().trim();

           if(main) {
               main = main.replace(/,/g, " ");
               sub = sub.replace(/,/g, " ");
               sub2 = sub2.replace(/,/g, " ");
               var itemStr = main;
               if (sub) itemStr += " - " + sub;
               if (sub2) itemStr += " - " + sub2;
               if (qty) {
                   itemStr += " (Qty: " + qty + " " + $.trim(unit) + ")";
                   itemStr += " {Price:" + totalText + "}"; 
               }
               serviceList.push(itemStr);
           }
        }
    });
    
    var servicesStr = serviceList.join(", ");
    var dataPackage = [orderId, date, team, servicesStr, startTime, endTime];

    // 2. UI Loading
    $('#error').remove();
    $("#msg-daily-submit").hide().text(""); 
    $("#btn-summary-submit").addClass('is-loading'); 

    // 3. Send to Backend
    google.script.run
        .withSuccessHandler(function(response) {
            $("#btn-summary-submit").removeClass('is-loading');
            
            var msg = response.message; 
            var isJobDone = response.isJobDone;
            var retOrderId = response.orderId; 

            if(response.status === "error") {
                $("#msg-daily-submit").removeClass('is-success').addClass('is-danger').text(msg).show();
            } else {
                $("#msg-daily-submit").removeClass('is-danger').addClass('is-success').text(msg).fadeIn();
                
                if (isJobDone === true) {
                    setTimeout(function() {
                        $("#msg-daily-submit").text("Job Complete! Generating Final Invoice...").show();
                        initiateFinalInvoice(retOrderId);
                    }, 1000);
                } else {
                    // --- RELOAD SECTION: REFRESH THE SCREEN INSTANTLY ---
                    setTimeout(function() {
                        // 1. Refresh Team Leader View if active
                        var currentTeam = $('#team-selected-after-password').text().trim();
                        if(currentTeam && currentTeam !== "Current Orders" && currentTeam !== "Select team") {
                            getTableTeamCurrentOrder(currentTeam);
                        }

                        // 2. Refresh Coordinator View (Calendar/Schedule) if active
                        var currentSchedDate = $("#schedule-date-picker").val();
                        if (currentSchedDate) { loadDailySchedule(currentSchedDate); }

                        // 3. Close Modals
                        $(".modal.completed").removeClass('is-active'); 
                        $('.invoice-box').hide();
                        $("#view-daily-summary").hide();
                        $("#view-daily-entry").hide();
                        $("#msg-daily-submit").hide();
                        
                    }, 1000);
                    // ----------------------------------------------------
                }
            }
        })
        .withFailureHandler(function(err) {
            $("#btn-summary-submit").removeClass('is-loading');
            $("#msg-daily-submit").removeClass('is-success').addClass('is-danger').text("Error: " + err).show();
        })
        .gasSubmitDailyServices(dataPackage);
}

  
  

function populateInvoiceTable(services) {
    var tbody = $('#table-invoice-item tbody');
    
    // 1. Clear old data
    $('#table-invoice-item tr.db-locked-item').remove();
    $('#table-invoice-item input').val(''); 
    $("td[name=total]").text("0.00");
    $("span[id$='-unit']").text("").hide();

    if (!services || services.length === 0) return;

    // --- NEW MERGE LOGIC ---
    var mergedMap = {};
    var mergedList = [];

    services.forEach(function(item) {
        // Create a unique key: Main | Sub1 | Sub2
        var key = (item.main || "").trim() + "|" + (item.sub1 || "").trim() + "|" + (item.sub2 || "").trim();
        
        if (mergedMap[key]) {
            // MERGE: If service exists, add Quantity and Total Price
            mergedMap[key].qty = parseFloat(mergedMap[key].qty) + parseFloat(item.qty);
            mergedMap[key].total = (parseFloat(mergedMap[key].total) + parseFloat(item.total)).toFixed(2);
        } else {
            // NEW: If service is new, add to list
            // Clone item to handle it safely
            var newItem = JSON.parse(JSON.stringify(item));
            newItem.qty = parseFloat(newItem.qty);
            newItem.total = parseFloat(newItem.total).toFixed(2);
            
            mergedMap[key] = newItem;
            mergedList.push(newItem);
        }
    });
    // -----------------------

    // 2. Loop through the MERGED list (instead of raw services)
    mergedList.forEach(function(s) {
        var inputStyle = "background-color: #fff; border: 1px solid #E5E7EB; color: #374151; cursor: default;";
        
        // Show visual checkmark if matched
        var iconHtml = s.isMatched ? 
            '<span class="icon is-small is-right has-text-success"><i class="fas fa-check-circle"></i></span>' : 
            '<span class="icon is-small is-right has-text-warning"><i class="fas fa-exclamation-triangle"></i></span>';

        var newRowHtml = `
        <tr class="db-locked-item">
            <td>
                <div class="control has-icons-right">
                    <input class="input chip-input" type="text" name="main" value="${s.main}" readonly style="${inputStyle}">
                    ${iconHtml}
                </div>
            </td>
            <td><input class="input chip-input" type="text" name="sub1" value="${s.sub1}" readonly style="${inputStyle}"></td>
            <td><input class="input chip-input" type="text" name="sub2" value="${s.sub2}" readonly style="${inputStyle}"></td>
            <td>
                <div style="display:flex; align-items:center;">
                    <input class="input chip-input" type="text" name="qty" value="${s.qty}" readonly style="text-align:center; ${inputStyle}">
                    <span class="unit-text" style="margin-left:5px; font-size:0.8rem; font-weight:600; color:#9CA3AF;"> ${s.unit || ""}</span>
                </div>
            </td>
            <td name="total" style="text-align: right; font-weight: 700; color:#111827; font-size:1.1rem; padding-top:10px;">${s.total}</td>
        </tr>`;
        
        tbody.prepend(newRowHtml);
    });

    calculateTotalCost(); 
}

  function initiateFinalInvoice(orderId) {
    isFinalInvoiceMode = true;
    $('#cover-spin').show();

    // Fetch ALL services (Team 1 + Team 2)
    google.script.run
        .withSuccessHandler(function(result) {
            $('#cover-spin').hide();
            
            // --- FIX: OPEN MODAL FIRST (Clears UI), THEN POPULATE ---
            setupInvoiceModal(); 
            
            // Populate the UI AFTER setting up the modal
            if (result.services) {
                populateInvoiceTable(result.services);
            } else {
                // Handle edge case where result might be raw array
                populateInvoiceTable(result);
            }

            // Combine Team Names (e.g. "Team 1 & Team 2")
            if (result.teams && result.teams.length > 0) {
                $("#entry-team").text(result.teams.join(" & "));
            }

            // Switch Views
            $("#view-daily-summary").hide();
            $("#view-final-invoice").fadeIn();
            $("#financial-sections").show();
            $("#section-payment-method").show();
            $("#btn-real-submit-invoice").show();

            // Header Updates
            $("#text-order-num").text(orderId);
            $("#sum-order-id").text(orderId);
            
            calculateTotalCost();
            $(".invoice-box")[0].scrollIntoView({behavior: "smooth"});
        })
        .withFailureHandler(function(err) {
            $('#cover-spin').hide();
            alert("Error generating final invoice: " + err);
        })
        .gasGetCompletedServices(orderId);
}
/* =================================================================================
   MASTER BLOCK: PASTE AT THE VERY BOTTOM OF YOUR <SCRIPT> TAG
   ================================================================================= */

   function showSummaryView() {
    // A. Copy Header Info from the Entry Screen
    $("#sum-order-id").text( $("#entry-order-num").text() );
    $("#sum-cust-name").text( $("#entry-cust-name").text() );
    $("#sum-cust-phone").text( $("#text-customer-phone").text() ); // Use hidden text field for cleaner phone
    $("#sum-team").text( $("#entry-team").text() );

    var tbody = $("#summary-table-body");
    tbody.empty();
    
    var grandTotal = 0.00;

    // B. Loop through the INPUTS (where you just edited the data)
    $('#table-invoice-item tr').each(function(i) {
        if (i > 0) { 
            // Read values from the inputs
            var main = $(this).find("input[name='main']").val();
            var sub1 = $(this).find("input[name='sub1']").val();
            var sub2 = $(this).find("input[name='sub2']").val();
            var qty = $(this).find("input[name='qty']").val();
            var unit = $(this).find("span[id$='-unit']").text();
            
            // Read total (it might be text in a span or td)
            var totalText = $(this).find("td[name='total']").text();
            var total = parseFloat(totalText) || 0;

            if(main) {
                grandTotal += total;
                // Create a Read-Only Row for the Summary
                var rowHtml = `
                <tr style="border-bottom: 1px solid #f5f5f5;">
                    <td style="padding:15px 5px;">${main}</td>
                    <td style="padding:15px 5px;">${sub1}</td>
                    <td style="padding:15px 5px;">${sub2}</td>
                    <td style="padding:15px 5px; text-align:center;">${qty} ${unit}</td>
                    <td style="padding:15px 5px; text-align:right;">${total.toFixed(2)}</td>
                </tr>`;
                tbody.append(rowHtml);
            }
        }
    });

    $("#sum-grand-total").text(grandTotal.toFixed(2));
    
    // C. Switch Views
    $("#view-daily-entry").hide();
    $("#view-daily-summary").fadeIn();
    
    // D. Scroll to top
    $(".invoice-box")[0].scrollIntoView({behavior: "smooth"});
}

// 1. UPDATED LISTENER: Adds the "Edit" button to the popup
function attachCoordinatorListeners() {
    $(".view-teams-btn").off("click").on("click", function() {
        var orderId = $(this).data('id');
        var custName = $(this).data('name');
        var custPhone = $(this).data('phone');
        var tasks = JSON.parse(decodeURIComponent($(this).data('tasks')));

        $('#popup-order-id').text(orderId);
        var tbody = $('#popup-tasks-body');
        tbody.empty();

        tasks.forEach(function(task) {
            var btnMeta = orderId + "**" + custName + "**" + custPhone + "**" + task.team + "**" + task.isFinal + "**" + task.dateId + "**" + task.startT + "**" + task.endT;
            var actionButtons = "";
            
            if (task.status === "Day Completed") {
                actionButtons = `
                    <button class="button is-info is-small popup-edit-btn" data-meta="${btnMeta}" style="background-color:#3298dc; color:white;">
                        <span class="icon is-small"><i class="fas fa-edit"></i></span> <span>Edit Services</span>
                    </button>
                    <button class="button is-primary is-small popup-inv-btn" data-meta="${btnMeta}">Invoice</button>
                `;
            } else {
                actionButtons = `
                    <button class="button is-warning is-small popup-day-btn" data-meta="${btnMeta}">Complete Day</button>
                    <button class="button is-light is-small" disabled title="Complete day first">Invoice</button>
                `;
            }

            var row = `<tr>
                <td><strong>${task.team}</strong></td>
                <td>${task.date}<br><small>${task.startT} - ${task.endT}</small></td>
                <td>${task.service}</td>
                <td><div class="buttons is-centered">${actionButtons}</div></td>
            </tr>`;
            tbody.append(row);
        });

        $('#teams-popup-modal').addClass('is-active');
    });

    $(".modal-close-popup, #button-close-modal, #button-cancel-modal").off("click").on("click", function() {
        $(".modal, #teams-popup-modal").removeClass('is-active');
    });
}

// 2. CLICK HANDLERS (Global) - USES .OFF() TO PREVENT DUPLICATES
$(document).off('click', '.popup-day-btn').on('click', '.popup-day-btn', function() {
    var meta = $(this).data('meta');
    handleCoordinatorAction(meta, false); 
    $('#teams-popup-modal').removeClass('is-active');
});

$(document).off('click', '.popup-edit-btn').on('click', '.popup-edit-btn', function() {
    var meta = $(this).data('meta');
    var parts = meta.split("**");
    // Parts: 0=ID, 1=Name, 2=Phone, 3=Team, 5=Date
    openEditExecutionModal(parts[0], parts[3], parts[5], parts[1], parts[2]); 
    $('#teams-popup-modal').removeClass('is-active');
});

$(document).off('click', '.popup-inv-btn').on('click', '.popup-inv-btn', function() {
    var meta = $(this).data('meta');
    handleCoordinatorAction(meta, true); 
    $('#teams-popup-modal').removeClass('is-active');
});

// 3. EDIT LOGIC: Fetches data and opens the box
// 3. EDIT LOGIC (Loads Old Data so you can Change it)
function openEditExecutionModal(orderId, teamName, dateStr, custName, custPhone) {
    $('#cover-spin').show();
    
    google.script.run
        .withSuccessHandler(function(data) {
            $('#cover-spin').hide();
            
            if(data.error) { alert("Server Error: " + data.error); return; }
            if(!data.found) { alert("Error: Record not found."); return; }

            // --- 1. Switch to Team Leader Tab to see the box ---
            $('#tabs li').removeClass('is-active');
            $('#tabs li').eq(2).addClass('is-active'); 
            $('.page').hide().eq(2).show();
            $('#protected-div-team').show(); 

            // --- 2. Fill Header & Time ---
            $("#text-order-num").text(orderId);
            $("#entry-order-num").text(orderId); 
            $("#text-customer-name").text(custName);
            $("#entry-cust-name").text(custName); 
            $("#text-customer-phone").text(custPhone);
            $("#entry-cust-phone").text(custPhone); 
            $("#entry-team").text(teamName);
            
            $('#edit-order-date').val(dateStr); 
            $('#edit-order-time').val(data.startTime);
            $('#edit-order-duration').val(data.endTime);

            // --- 3. Fill Table with OLD DATA ---
            clearInvoice(false); 
            var serviceString = data.services;
            
            if(serviceString) {
                var separator = serviceString.includes(" || ") ? " || " : ", ";
                var items = serviceString.split(separator);
                
                items.forEach(function(item, index) {
                    // Add a new row for every item
                    if(index > 0) $("#button-add-row").click();
                    var rowNum = index + 1;
                    
                    // Parse: "Service (Qty: 1 Unit) {Price:100}"
                    var priceMatch = item.match(/\{Price:([\d\.]+)\}/i);
                    var price = priceMatch ? priceMatch[1] : "0.00";
                    
                    var cleanItem = item.replace(/\{Price:[\d\.]+\}/i, "").trim();
                    var qtyMatch = cleanItem.match(/\(Qty:\s*(\d+)\s*(.*?)\)/i);
                    var qty = qtyMatch ? qtyMatch[1] : "";
                    var unit = qtyMatch ? qtyMatch[2] : "";
                    
                    var nameOnly = cleanItem.replace(/\(Qty:.*?\)/, "").trim();
                    var parts = nameOnly.split(" - ");
                    
                    // --- POPULATE INPUTS ---
                    $("#" + rowNum + "-main").val(parts[0] || "");
                    $("#" + rowNum + "-sub1").val(parts[1] || "");
                    $("#" + rowNum + "-sub2").val(parts[2] || "");
                    $("#" + rowNum + "-qty").val(qty);
                    $("#" + rowNum + "-unit").text(unit).show();
                    $("#" + rowNum + "-total").text(price);
                    
                    // Re-attach autocomplete so editing works
                    addAutoCompleteToNewRow($("#" + rowNum + "-main"), rowNum);
                });
                
                // --- FIX: RECALCULATE TOTALS IMMEDIATELY ---
                calculateTotalCost(); 
            }

            // --- 4. Setup "Update" Button ---
            $("#btn-summary-submit").unbind("click").click(function() {
                 updateExecutionLog(orderId, teamName, dateStr);
            });
            $("#btn-summary-submit span:last").text("Update Entry");

            // --- 5. Open the UI ---
            setupInvoiceModal(); 
        })
        .withFailureHandler(function(err) {
            $('#cover-spin').hide();
            alert("System Error: " + err);
        })
        .gasGetExecutionLog(orderId, teamName, dateStr);
}

// 4. UPDATE FUNCTION: Saves changes to backend
function updateExecutionLog(orderId, teamName, dateStr) {
    $("#btn-summary-submit").addClass('is-loading');
    
    // Re-pack services from the INPUTS (which contain the NEW data)
    var serviceList = [];
    $('#table-invoice-item tr').each(function(i) {
       if (i > 0) { 
           var main = $(this).find("input[name='main']").val();
           var sub1 = $(this).find("input[name='sub1']").val();
           var sub2 = $(this).find("input[name='sub2']").val();
           var qty = $(this).find("input[name='qty']").val();
           var unit = $(this).find("span[id$='-unit']").text().trim();
           var price = $(this).find("td[name='total']").text().trim();
           
           if(main) {
               var str = main;
               if(sub1) str += " - " + sub1;
               if(sub2) str += " - " + sub2;
               if(qty) str += " (Qty: " + qty + " " + unit + ")";
               str += " {Price:" + price + "}";
               serviceList.push(str);
           }
       }
    });
    
    var newServices = serviceList.join(" || ");
    var newStart = $('#edit-order-time').val();
    var newEnd = $('#edit-order-duration').val();

    google.script.run.withSuccessHandler(function(msg) {
        $("#btn-summary-submit").removeClass('is-loading');
        alert(msg);
        
        // Hide boxes
        $(".invoice-box").hide();
        $("#view-daily-entry").hide();
        $("#view-daily-summary").hide();
        
        // Return to Coordinator Tab
        $('#tabs li').removeClass('is-active');
        $('#tabs li').eq(1).addClass('is-active'); 
        $('.page').hide().eq(1).show();
        
    }).gasUpdateExecutionLog(orderId, teamName, dateStr, newServices, newStart, newEnd);
}

// 5. GLOBAL UI HELPERS
function setupInvoiceModal() {
    clearInvoice(false); 
    
    $("#view-daily-entry").hide();
    $("#view-daily-summary").hide();
    $("#view-final-invoice").hide();
    
    $("#entry-order-num").text( $("#text-order-num").text() );
    $("#entry-cust-name").text( $("#text-customer-name").text() );
    $("#entry-cust-phone").text( $("#text-customer-phone").text() );
    
    $("#view-daily-entry").show();
    
    $("#btn-goto-summary").show(); 
    $("#button-submit-final").hide(); 
    $(".grand-total-box").css("display", "flex");
    $(".dark-header").show(); 
    $("#financial-sections").hide(); 

    // Show the box
    $('.invoice-box').css({"height": "", "overflow": "", "padding": "0", "border" :"none"}).show();
    $(".invoice-box")[0].scrollIntoView({behavior: "smooth"});
}

function clearInvoice(clearButton) {
    // 1. Destroy ALL rows except the header (Index 0)
    $('#table-invoice-item tr').not(':first').remove();

    // 2. Reset Total Counters
    $("td[name=total]").text("0.00");
    $('#table-invoice-item input').val('');
    
    $('#services-subtotal').text('0.00');
    $('#spare-subtotal').text('0.00');
    $('#location-subtotal').text('0.00');
    $('#discount-subtotal').text('0.00');
    $('#total-amount').text('0.00');
    $('#entry-grand-total').text('0.00');
    
    // 3. FORCE ADD A FRESH ROW
    // This triggers the click event on "Add Service", which generates a clean, working row with autocomplete.
    $("#button-add-row").click();
    
    if(clearButton){
        $('#button-view-invoice').remove();
        $('#button-send-whatsapp').remove();
    }
}

function handleCoordinatorAction(meta, wantInvoice) {
    var parts = meta.split("**");
    var orderId = parts[0];
    var teamName = parts[3];

    if (!wantInvoice) {
        // Switch to Team Leader Tab
        $('#tabs li').removeClass('is-active');
        $('#tabs li').eq(2).addClass('is-active'); 
        $('.page').hide().eq(2).show();
        
        $('#password-div-team').hide();
        $('#team-leader-team-div').hide();
        $('#protected-div-team').show();
        $('#team-logout-container').show();
        $('#team-selected-after-password').text(teamName);
        getTableTeamCurrentOrder(teamName);
        
        setTimeout(function() {
            var target = $("td:contains('" + orderId + "')").closest('.card');
            if (target.length) target[0].scrollIntoView({ behavior: "smooth" });
        }, 800);
    } else {
        $("#text-order-num").text(orderId);
        $("#text-customer-name").text(parts[1]);
        $("#text-customer-phone").text(parts[2]);
        $("#entry-team").text(teamName);
        isFinalInvoiceMode = true;
        
        // Ensure we switch to Team Leader Tab to see the Invoice Box
        $('#tabs li').removeClass('is-active');
        $('#tabs li').eq(2).addClass('is-active'); 
        $('.page').hide().eq(2).show();
        $('#password-div-team').hide();
        $('#team-leader-team-div').hide();
        $('#protected-div-team').show();
        
        initiateFinalInvoice(orderId);
    }
}

</script>

</html>